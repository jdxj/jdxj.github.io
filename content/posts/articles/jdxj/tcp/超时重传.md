---
title: "超时重传"
date: 2023-04-09T11:08:12+08:00
tags:
  - tcp
---

Retransmission TimeOut，RTO

# 计算RTO

## 经典方法

- 适用 RTT 波动较小的情况
- 取平均值

Smoothed round trip time，SRTT

- α 是平滑因子，建议值是0.8 ~ 0.9

```
SRTT = ( α * SRTT ) + ((1- α) * RTT)
```

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f94bd77bdf01456386b31ed4557c026f~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

超时重传时间 RTO 的计算公式

- β 是加权因子，一般推荐值为 1.3 ~ 2.0

```
RTO = min(ubound, max(lbound, β * SRTT))
```

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1eb8c111efbe427a8c5c3739a1e7f65b~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

## 标准方法（Jacobson / Karels 算法）

公式

```
SRTT = (1 -  α) * SRTT +  α * RTT
// 已平滑的 RTT 平均偏差估计器 round-trip time variation
RTTVAR = (1 - β) * RTTVAR + β * (|RTT-SRTT|) 
RTO= µ * SRTT + ∂ * RTTVar
```

- 权重因子 α 的建议值是 0.125

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/71184a1c2d2a403284492bbdb5785788~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

- 平均偏差是标准方差的良好近似，计算较为容易，无需标准方差的求平方根运算。
- β 取建议值 0.25

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d9e5e2d1630e4822b6d16ae1598a780d~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

- μ 建议值取 1，∂ 建议值取 4

这种算法下 RTO 与 RTT 变化的差值关系更密切，能对变化剧烈的 RTT做出更及时的调整。

# 重传二义性与 Karn / Partridge 算法

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b3a928957ccf49fda352a68227fe7734~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

Karn / Partridge 算法就是为了解决重传二义性的。它的思路也是很奇特，解决问题的最好办法就是不解决它：

- 既然不能确定 ACK 包到底对应重传包还是非重传包，那这次就忽略吧，这次重传的 RTT 不会被用来更新 SRTT 及后面的 RTO
- 只有当收到未重传过的某个请求的 ACK 包时，才更新 SRTT 等变量并重新计算RTO

Karn 算法采用了出现重传就将 RTO 翻倍的方法，指数级退避（Exponential backoff）。

- /proc/sys/net/ipv4/tcp_retries2
