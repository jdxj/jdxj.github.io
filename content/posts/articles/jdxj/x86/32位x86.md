---
title: "32位x86"
date: 2023-08-31T13:53:11+08:00
tags:
  - x86
---

# IA-32架构的基本执行环境

## 寄存器的扩展

32位处理器内部的通用寄存器

![](https://res.weread.qq.com/wrepub/CB_3300050845_txt014_1.jpg)

指令的源操作数和目的操作数必须具有相同的长度，个别特殊用途的指令除外。

如果目的操作数是32位寄存器，源操作数是立即数，那么，立即数被视为32位的

32位处理器的指令指针、标志和段寄存器

![](https://res.weread.qq.com/wrepub/CB_3300050845_txt014_6.jpg)

在32位模式下，对内存的访问从理论上来说不需要再分段，因为它有32根地址线，可以自由访问任何一个内存位置。但是，IA-32架构的处理器是基于分段模型
的，因此，32位处理器依然需要以段为单位访问内存，即使它工作在32位模式下。不过，它也提供了一种变通的方案，即只分一个段，段的基地址是
0x00000000，段的长度（大小）是4GB。在这种情况下，可以视为不分段，即**平坦模型**(Flat Mode)。

每个程序都有属于自己的内存空间。在16位模式下，一个程序可以自由地访问不属于它的内存位置，甚至可以对那些地方的内容进行修改。这当然是不安全的，
也不合法，但却没有任何机制来限制这种行为。在32位模式下，处理器要求在加载程序时，先定义该程序所拥有的段，然后才允许使用这些段。定义段时，除基
地址（起始地址）外，还附加了段界限、特权级别、类型等属性。当程序访问一个段时，处理器将用固件实施各种检查工作，以防止对内存的违规访问。

在32位模式下，传统的段寄存器，如CS、SS、DS、ES，保存的不再是16位逻辑段地址，而是段的选择子，即用于选择所要访问的段，因此，这一部分也叫作段
选择器。除段选择器外，每个段寄存器还包括一个不可见部分，称为描述符高速缓存器，里面有段的基地址和各种访问属性。这部分内容程序不可访问，由处理
器自动使用。

32位处理器增加了两个额外的段寄存器FS和GS。对于某些复杂的程序来说，多出两个段寄存器可能会令它们感到高兴。

## 基本的工作模式

1982年的时候，INTEL公司推出了80286处理器。这也是一款16位的处理器，大部分的寄存器都和8086处理器一样。因此，80286和8086一样，因为段寄存器
是16位的，而且只能使用16位的偏移地址，在实模式下只能使用64KB的段；尽管它有24根地址线，理论上可以访问2^24，即16MB的内存，但依然只能分成多个
段来进行。

但是，80286和8086不一样的地方在于，它第一次提出了保护模式的概念。在保护模式下，段寄存器中保存的不再是逻辑段地址，而是段选择子，真正的段地址
位于段寄存器的描述符高速缓存中，是24位的。因此，运行在保护模式下的80286处理器可以访问全部16MB内存。

80286处理器访问内存时，不再需要将段地址左移，因为在段寄存器的描述符高速缓存器中有24位的段物理基地址。这样一来，
**段可以位于16MB内存空间中的任何位置**，而不再限于低端1MB范围内，也不必非得是位于16字节对齐的地方。不过，由于80286的通用寄存器是16位的，
只能提供16位的偏移地址，因此，和8086一样，即使是运行在保护模式下，**段的长度依然不能超过64KB**。对段长度的限制妨碍了80286处理器的应用，这
就是16位保护模式很少为人所知的原因。

**1985年的80386处理器是INTEL公司的第一款32位产品**，而且获得了极大成功，是后续所有32位产品的基础。和8086、80286不同，
**80386处理器的寄存器是32位的，而且拥有32根地址线**，可以访问2^32，即4GB的内存。

80386，以及所有后续的32位处理器，都兼容实模式，可以运行实模式下的8086程序。而且，**在刚加电时，这些处理器都自动处于实模式下**，此时，它相
当于一个非常快速的8086处理器。只有在进行一番设置之后，才能运行在保护模式下。

## 线性地址和分页

传统上，段地址和偏移地址称为逻辑地址，偏移地址叫作有效地址(Effective Address, EA)，在指令中给出有效地址的方式叫作寻址方式(Addressing
Mode)。

```nasm
inc word [bx + si + 0x06]
```

在分段模型下，内存的分配是不定长的，程序大时，就分配一大块内存；程序小时，就分配一小块。时间长了，内存空间就会碎片化，就有可能出现一种情况：
内存空间是有的，但都是小块，无法分配给某个任务。为了解决这个问题，IA-32处理器支持分页功能，分页功能将物理内存空间划分成逻辑上的页。页的大小
一般为4KB，通过使用页，可以简化内存管理。

当页功能开启时，段部件产生的地址就不再是物理地址了，而是线性地址(Linear Address)，线性地址还要经页部件转换后，才是物理地址。

![](https://res.weread.qq.com/wrepub/CB_3300050845_txt014_8.jpg)

线性地址的概念用来描述任务的地址空间。IA-32处理器上的每个任务都拥有4GB的虚拟内存空间，这是一段长4GB的平坦空间，就像一段平直的线段，因此叫
线性地址空间。相应的，由段部件产生的地址，就对应着这条线段上的每个点，这就是线性地址。
