---
title: "一对多通讯"
date: 2023-06-21T12:31:18+08:00
tags:
  - broadcast
  - multicast
---

分布式系统的服务发现，使用人工配置既容易出错，速度也慢，而用广播就可以轻松实现自动化服务发现。

# 广播是怎么实现的？

广播要改用 UDP 协议

网络设备天然就拥有广播能力，当它在一个网络端口上收到主机发来的报文时，可以向其他端口上的所有主机重发一遍

![](https://static001.geekbang.org/resource/image/ce/f0/ce45d52f5c87bcae9c4adae8056c21f0.jpg?wh=1394*1044)

根据网络分层模型，上层协议可以使用下层协议的功能，所以传输层协议拥有 IP 协议的广播能力。同时，传输层通过端口号把网络报文和进程关联在了一起

![](https://static001.geekbang.org/resource/image/13/ac/13d968cbacd229f242764557957d3bac.jpg?wh=1642*858)

传输层的 TCP 协议为了保证可靠性，建立了逻辑上的连接概念，由于一个连接上只能有两方，所以 TCP 无法进行一对多通讯。而传输层的 UDP 协议无需建立连接，
所以我们常用 UDP 协议发送广播。

广播的性能高有两个原因：

- 首先，交换机直接转发给接收方，要比从发送方到接收方的传输路径更短。
- 其次，原本需要发送方复制多份报文再逐一发送至各个接受者的工作，被交换机完成了，这既分担了发送方的负载，也充分使用了整个网络的带宽。

交换机收到消息后，怎么知道这是广播报文并转发给整个网络呢？

- 以太网中的数据链路层，通过硬件的 MAC 地址来传播消息，交换机就通过报文的 MAC 地址来确定是否需要广播。当交换机收到目标 MAC 地址是
  ff:ff:ff:ff:ff:ff 的报文时，便知道这是一个广播报文，才会将它转发给局域网中的所有主机，否则只会转发给 MAC 地址对应端口上的主机。
- 写代码时无法控制底层的 MAC 地址，只能填写目标 IP 地址
  - 如果只是对所在子网进行广播，那么使用受限广播地址 255.255.255.255 就可以了；
  - 如果局域网划分了多个子网，主机需要向其他子网广播，则需要正确地设置直接广播地址（路由器需要打开直接广播功能）。

如何正确地设置直接广播 IP 地址？

![](https://static001.geekbang.org/resource/image/4f/e1/4f9c58b60404e2f874802b6a2ec207e1.jpg?wh=1718*922)

主机 ID 不会出现全 0 和全 1 这两种情况，这是因为全 0 和全 1 有特殊用途，其中全 0 特指它自己（所以 0.0.0.0 可以指代本机 IP），而全 1 表示全
部主机。

**主机 ID 的比特位全部设为 1 后就是广播地址。**

- 比如，192.168.0.101 是 C 类地址，把主机 ID 从 101 改为 255 后，就可以用 192.168.0.255 发送广播了。

> 有点歧义, 这里是指目标地址改为192.168.0.255? 把每个要接收广播的主机的地址改为192.168.0.255貌似不对

CIDR 这种新的划分方式，它通过子网掩码（或者叫 Netmask），可以在任意的位置将 IP 地址拆分为网络 ID 和主机 ID，扩展了 A、B、C 三类网络的用法。

![](https://static001.geekbang.org/resource/image/65/08/6586d4ec875f63b19993b78c7a11e808.jpg?wh=1740*1000)

# 用更精准的组播来做服务发现

广播报文在这 3 个步骤后会被丢弃：

- 第 1 步，网卡设备收到报文后，查看报文中的目标 MAC 地址是否与本机的 MAC 地址匹配，如果不匹配就会丢弃。广播 MAC 地址默认匹配，继续交由上层的
  IP 协议栈处理；
- 第 2 步，IP 协议栈查看目标 IP 地址是否为本机 IP 地址，不匹配也会丢弃报文。上文介绍过的广播 IP 地址同样默认匹配，交由传输层协议继续处理。
- 第 3 步，传输层检查目标端口是否有进程在监听，如果没有则丢弃报文，反之则交付给进程处理。不属于集群的主机自然不会启动服务监听端口，在这一步才会丢
  弃广播报文。

![](https://static001.geekbang.org/resource/image/1c/b3/1c8b6032474debdd2a4d4569a1752ab3.jpg?wh=1070*976)

组播是一种“定向广播”，它设定了一个虚拟组，用组播 IP 来标识。这个虚拟组中可以包含多个主机的 IP，当向对应的组播 IP 发送消息时，仅在这个组内的主机
才能收到消息。

组播ip是D类地址, 范围是从 224.0.0.0 到 239.255.255.255

当设置好组播 IP 地址后，还要通过管理组播地址的 IGMP 协议（Internet Group Management Protocol），将主机 IP 地址添加进虚拟组中。

组播相对于广播而言 ，除了能够更精准的管理组播范围，还能够跨越多个网络工作。当然，如果将多个网络中的 IP 加入同一虚拟组时，需要涉及到的路由器都可以
正确地处理这些 IP 地址，且都能支持 IGMP 协议。
