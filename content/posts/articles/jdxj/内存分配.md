---
title: "内存分配"
date: 2023-06-20T22:28:08+08:00
tags:
  - memory
---

内存申请流程

![](https://static001.geekbang.org/resource/image/89/6a/893edd82d03c628fae83b95bd4fbba6a.jpg?wh=2089*1745)

几乎所有程序都在使用 C 库内存池分配出的内存。C 库内存池影响着系统下依赖它的所有进程。

// todo: go 如何向系统申请内存?

# 选择 Ptmalloc2 还是 TCMalloc？

Ptmalloc2 假定，如果线程 A 申请并释放了的内存，线程 B 可能也会申请类似的内存，所以它允许内存池在线程间复用以提升性能。

- 分配内存时要加锁
- 当应用场景涉及大量的并发线程时，换成 TCMalloc 库也更有优势！
- Ptmalloc2 更擅长大内存的分配。

TCMalloc 特意针对小内存做了优化, 

- TCMalloc 把内存分为 3 个档次，小于等于 256KB 的称为小内存，从 256KB 到 1M 称为中等内存，大于 1MB 的叫做大内存。TCMalloc 对中等内存、大
  内存的分配速度很慢

# 为什么从栈中分配内存会更快

由于每个线程都有独立的栈，所以分配内存时不需要加锁保护，而且栈上对象的尺寸在编译阶段就已经写入可执行文件了，执行效率更高！性能至上的 Golang 语言
就是按照这个逻辑设计的，即使你用 new 关键字分配了堆内存，但编译器如果认为在栈中分配不影响功能语义时，会自动改为在栈中分配。
