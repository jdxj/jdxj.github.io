---
title: "第6章 整数集合"
date: 2023-04-24T16:32:01+08:00
---

查看底层编码

```bash
redis> SADD numbers 1 3 5 7 9
(integer) 5
redis> OBJECT ENCODING numbers
"intset"
```

## 6.1 整数集合的实现

intset.h/intset

```c
typedef struct intset {
    //编码方式
    uint32_t encoding;
    //集合包含的元素数量
    uint32_t length;
    //保存元素的数组(可以视为[]byte)
    int8_t contents[];
} intset;
```

contents数组按从小到大的顺序保存元素

contents数组并不保存任何int8_t类型的值，contents数组的真正类型取决于encoding属性的值

- 如果encoding属性的值为INTSET_ENC_INT16，那么contents就是一个int16_t类型的数组，数组里的每个项都是一个int16_t类型的整数值（最小值为
  -32768，最大值为32767）。
- 如果encoding属性的值为INTSET_ENC_INT32，那么contents就是一个int32_t类型的数组，数组里的每个项都是一个int32_t类型的整数值（最小值为
  -2147483648，最大值为2147483647）。
- 如果encoding属性的值为INTSET_ENC_INT64，那么contents就是一个int64_t类型的数组，数组里的每个项都是一个int64_t类型的整数值（最小值为
  -9223372036854775808，最大值为9223372036854775807）。

图6-1 一个包含五个int16_t类型整数值的整数集合

![](https://res.weread.qq.com/wrepub/epub_622000_55)

## 6.2 升级

每当我们要将一个新元素添加到整数集合里面，并且新元素的类型比整数集合现有所有元素的类型都要长时，整数集合需要先进行升级（upgrade），然后才能将新元
素添加到整数集合里面。

1. 根据新元素的类型，扩展整数集合底层数组的空间大小，并为新元素分配空间。
2. 将底层数组现有的所有元素都转换成与新元素相同的类型，并将类型转换后的元素放置到正确的位上，而且在放置元素的过程中，需要继续维持底层数组的有序性
   质不变。
3. 将新元素添加到底层数组里面。

向整数集合添加新元素的时间复杂度为O(N)。

> 扩容复杂度?

# 6.3 升级的好处

### 6.3.1 提升灵活性

避免类型错误

### 6.3.2 节约内存

只在有更大的数据需要保存时才升级

## 6.4 降级

不支持降级操作

## 6.5 整数集合API

表6-1 整数集合API

![](https://res.weread.qq.com/wrepub/epub_622000_67)

## 6.6 重点回顾

- 整数集合是集合键的底层实现之一。
- 整数集合的底层实现为数组，这个数组以有序、无重复的方式保存集合元素，在有需要时，程序会根据新添加元素的类型，改变这个数组的类型。
- 升级操作为整数集合带来了操作上的灵活性，并且尽可能地节约了内存。
- 整数集合只支持升级操作，不支持降级操作。
