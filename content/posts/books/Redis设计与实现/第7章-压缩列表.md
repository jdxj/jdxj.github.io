---
title: "第7章 压缩列表"
date: 2023-04-26T11:47:42+08:00
---

## 7.1 压缩列表的构成

图7-1 压缩列表的各个组成部分

![](https://res.weread.qq.com/wrepub/epub_622000_68)

表7-1 压缩列表各个组成部分的详细说明

![](https://res.weread.qq.com/wrepub/epub_622000_69)

图7-2 包含三个节点的压缩列表

![](https://res.weread.qq.com/wrepub/epub_622000_70)

## 7.2 压缩列表节点的构成

个压缩列表节点可以保存一个字节数组或者一个整数值

字节数组可以是以下三种长度的其中一种：

- 长度小于等于63（2^6–1）字节的字节数组；
- 长度小于等于16383（2^14–1）字节的字节数组；
- 长度小于等于4294967295（2^32–1）字节的字节数组；

整数值则可以是以下六种长度的其中一种：

- 4位长，介于0至12之间的无符号整数；
- 1字节长的有符号整数；
- 3字节长的有符号整数；
- int16_t类型整数；
- int32_t类型整数；
- int64_t类型整数。

图7-4 压缩列表节点的各个组成部分

![](https://res.weread.qq.com/wrepub/epub_622000_72)

### 7.2.1 previous_entry_length

previous_entry_length属性的长度可以是1字节或者5字节：

- 如果前一节点的长度小于254字节，那么previous_entry_length属性的长度为1字节：前一节点的长度就保存在这一个字节里面。
- 如果前一节点的长度大于等于254字节，那么previous_entry_length属性的长度为5字节：其中属性的第一字节会被设置为0xFE（十进制值254），而之后的
  四个字节则用于保存前一节点的长度。

图7-5 当前节点的前一节点的长度为5字节

![](https://res.weread.qq.com/wrepub/epub_622000_73)

图7-6 当前节点的前一节点的长度为10086字节

![](https://res.weread.qq.com/wrepub/epub_622000_74)

图7-7 通过指针运算计算出前一个节点的地址

![](https://res.weread.qq.com/wrepub/epub_622000_75)

### 7.2.2 encoding

节点的encoding属性记录了节点的content属性所保存数据的类型以及长度：

- 一字节、两字节或者五字节长，值的最高位为00、01或者10的是字节数组编码：这种编码表示节点的content属性保存着字节数组，数组的长度由编码除去最高两
  位之后的其他位记录；
- 一字节长，值的最高位以11开头的是整数编码：这种编码表示节点的content属性保存着整数值，整数值的类型和长度由编码除去最高两位之后的其他位记录；

表格中的下划线“_”表示留空，而b、x等变量则代表实际的二进制数据，为了方便阅读，多个字节之间用空格隔开。

表7-2 字节数组编码

![](https://res.weread.qq.com/wrepub/epub_622000_77)

表7-3 整数编码

![](https://res.weread.qq.com/wrepub/epub_622000_78)

### 7.2.3 content

图7-9 保存着节数组"hello world"的节点

![](https://res.weread.qq.com/wrepub/epub_622000_79)

图7-10 保存着整数值10086的节点

![](https://res.weread.qq.com/wrepub/epub_622000_80)

## 7.3 连锁更新

图7-13 连锁更新过程

![](https://res.weread.qq.com/wrepub/epub_622000_83)

因为连锁更新在最坏情况下需要对压缩列表执行N次空间重分配操作，而每次空间重分配的最坏复杂度为O(N)，所以连锁更新的最坏复杂度为O(N^2)。

尽管连锁更新的复杂度较高，但它真正造成性能问题的几率是很低的：

- 首先，压缩列表里要恰好有多个连续的、长度介于250字节至253字节之间的节点，连锁更新才有可能被引发，在实际中，这种情况并不多见；
- 其次，即使出现连锁更新，但只要被更新的节点数量不多，就不会对性能造成任何影响：比如说，对三五个节点进行连锁更新是绝对不会影响性能的；

因为以上原因，ziplistPush等命令的平均复杂度仅为O(N)

## 7.4 压缩列表API

表7-4 压缩列表API

![](https://res.weread.qq.com/wrepub/epub_622000_85)

## 7.5 重点回顾

- 压缩列表是一种为节约内存而开发的顺序型数据结构。
- 压缩列表被用作列表键和哈希键的底层实现之一。
- 压缩列表可以包含多个节点，每个节点可以保存一个字节数组或者整数值。
- 添加新节点到压缩列表，或者从压缩列表中删除节点，可能会引发连锁更新操作，但这种操作出现的几率并不高。
