---
title: "第2章 简单动态字符串 Simple Dynamic String"
date: 2023-04-18T13:09:02+08:00
---

## 2.1 SDS的定义

```c++
struct sdshdr {
    //记录buf数组中已使用字节的数量
    //等于SDS所保存字符串的长度
    int len;
    //记录buf数组中未使用字节的数量
    int free;
    //字节数组，用于保存字符串
    char buf[];
};
```

图2-1 SDS示例

![](https://res.weread.qq.com/wrepub/epub_622000_3)

- len不统计`\0`
- `\0`由SDS函数自动处理
- 遵循空字符结尾这一惯例的好处是，SDS可以直接重用一部分C字符串函数库里面的函数

图2-2 带有未使用空间的SDS示例

![](https://res.weread.qq.com/wrepub/epub_622000_4)

## 2.2 SDS与C字符串的区别

图2-3 C字符串

![](https://res.weread.qq.com/wrepub/epub_622000_5)

### 2.2.1 常数复杂度获取字符串长度

获取C字符串的长度必须遍历整个字符串, 复杂度为O(N)

图2-4 计算C字符串长度的过程

![](https://res.weread.qq.com/wrepub/epub_622000_6)

SDS只要访问len属性即可

图2-5 5字节长的SDS

![](https://res.weread.qq.com/wrepub/epub_622000_7)

### 2.2.2 杜绝缓冲区溢出

C字符串不记录剩余空间, 拼接字符串会覆盖其后数据

```c++
char *strcat(char *dest, const char *src);
```

图2-7 在内存中紧邻的两个C字符串

![](https://res.weread.qq.com/wrepub/epub_622000_9)

```c++
strcat(s1, " Cluster");
```

图2-8 S1的内容溢出到了S2所在的位置上

![](https://res.weread.qq.com/wrepub/epub_622000_10)

SDS会检查剩余空间, 不足时会扩容

```c++
// redis字符串拼接函数
sdscat(s, " Cluster");
```

图2-9 sdscat执行之前的SDS

![](https://res.weread.qq.com/wrepub/epub_622000_11)

图2-10 sdscat执行之后的SDS

![](https://res.weread.qq.com/wrepub/epub_622000_12)

### 2.2.3 减少修改字符串时带来的内存重分配次数

1. 空间预分配

- 修改后的`len<1MB`时, 会分配`free=len`的空闲空间
- 修改后的`len>=1MB`时, 会分配`free=1MB`的空闲空间

图2-11 执行sdscat之前的SDS

![](https://res.weread.qq.com/wrepub/epub_622000_13)

```c++
sdscat(s, " Cluster");
```

图2-12 执行sdscat之后SDS

![](https://res.weread.qq.com/wrepub/epub_622000_14)

```c++
sdscat(s, " Tutorial");
```

有足够空间, 无须内存分配

图2-13 再次执行sdscat之后的SDS

![](https://res.weread.qq.com/wrepub/epub_622000_15)

2. 惰性空间释放

不立即释放空间, 使用free记录

图2-14 执行sdstrim之前的SDS

![](https://res.weread.qq.com/wrepub/epub_622000_16)

```c++
sdstrim(s, "XY"); //移除SDS字符串中的所有'X'和'Y'
```

图2-15 执行sdstrim之后的SDS

![](https://res.weread.qq.com/wrepub/epub_622000_17)

> 有真正释放未使用空间的API

### 2.2.4 二进制安全

- C字符串以`\0`来表示结束, 所以数据中不能包含`\0`
- SDS使用len来判断是否结束

图2-18 保存了特殊数据格式的SDS

![](https://res.weread.qq.com/wrepub/epub_622000_20)

### 2.2.5 兼容部分C字符串函数

重用`<string.h>`

```c++
strcasecmp(sds-＞buf, "hello world");
strcat(c_string, sds-＞buf);
```

### 2.2.6 总结

表2-1 C字符串和SDS之间的区别

![](https://res.weread.qq.com/wrepub/epub_622000_22)

## 2.3 SDS API

表2-2 SDS的主要操作API

![](https://res.weread.qq.com/wrepub/epub_622000_23)

## 2.4 重点回顾

- Redis只会使用C字符串作为字面量，在大多数情况下，Redis使用SDS（Simple Dynamic String，简单动态字符串）作为字符串表示。
- 比起C字符串，SDS具有以下优点
  - 常数复杂度获取字符串长度。
  - 杜绝缓冲区溢出。
  - 减少修改字符串长度时所需的内存重分配次数。
  - 二进制安全。
  - 兼容部分C字符串函数。

## 2.5 参考资料
