---
title: "1-12 SQL编程方法"
date: 2023-03-11T10:29:57+08:00
---

# 写在前面

下面两张卡片上各画了几个圆圈，哪个更容易数清楚呢？

![](https://res.weread.qq.com/wrepub/epub_26211874_292)

编程行为就像是一种沟通方式。因此，对编程风格的研究也可以看成是对提高系统开发中沟通效率的方法的研究（因此在只有一个人编程的项目中，很难注意到
代码风格的重要性）。

# 表的设计

## 名字和意义

- 名称既包括用来指代具体东西的固有名称，也包括用来指代概念或者集合的一般名称。
- 地址没有指代任何具有实际意义的概念或者事物。

命名时允许的字符有以下3种

- 英文字母
- 阿拉伯数字
- 下划线“_”

## 属性和列

在数据库中，列代表的是“属性”，因此应该具有一贯性。

- 有些时候指代的是年龄，有些时候指代的是体重, 这种设计是不允许的

# 编程的方针

## 注释

就SQL而论，最好还是写注释。这样说主要有两个原因：

- SQL是声明式语言，即使表达同样的处理过程，逻辑仍然比面向过程语言凝练得多；
- SQL很难进行分步的执行调试。分析代码时主要需要进行桌面调试。

注释的写法有以下两种

```sql
    -- 单行注释
    -- 从SomeTable中查询col_1
    SELECT col_1
      FROM SomeTable;
```

```sql
    /＊
     多行注释
     从SomeTable中查询col_1
    ＊/
    SELECT col_1
      FROM SomeTable;
```

SQL语句中不能有空行，却可以像下面这样加入注释。

```sql
    SELECT col_1
      FROM SomeTable
     WHERE col_1 ='a'
      AND col_2 ='b'
      -- 下面的条件用于指定col_3的值是’c’或者’d'
      AND col_3 IN ('c', 'd');
```

注释也可以与代码在同一行

```sql
    SELECT col_1    -- 从SomeTable中查询col_1
      FROM SomeTable;
```

## 缩进

```sql
    --√好的示例
    SELECT col_1,
          col_2,
          col_3,
          COUNT(＊)
      FROM tbl_A
     WHERE col_1 ='a'
      AND col_2 = ( SELECT MAX(col_2)

                          FROM tbl_B
                         WHERE col_3 = 100 )
        GROUP BY col_1,
                col_2,
                col_3
```

```sql
    --×坏的示例
    SELECT col_1, col_2, col_3, COUNT(＊)
    FROM   tbl_A
    WHERE  col_1 ='a'
    AND    col_2 = (
    SELECT MAX(col_2)
    FROM   tbl_B
    WHERE  col_3 = 100
    ) GROUP BY col_1, col_2, col_3
```

比起①这种所有关键字都顶格左齐的写法，②这种让关键字右齐的写法更好。

①左齐

```sql
    SELECT
    FROM
    WHERE
    GROUP BY
    HAVING
    ORDER BY
```

②右齐

```sql
    SELECT
      FROM

        WHERE
        GROUP BY
       HAVING
        ORDER BY
```

## 空格

```sql
    --√好的示例
    SELECT  col_1
      FROM  tbl_A A, tbl_B B
     WHERE  ( A.col_1 >= 100 OR A.col_2 IN ('a', 'b') )
      AND  A.col_3 = B.col_3;
```

```sql
    --×坏的示例
    SELECT col_1
      FROM tbl_A A, tbl_B B
     WHERE (A.col_1>=100 OR A.col_2 IN ('a', 'b'))
      AND A.col_3=B.col_3;
```

## 大小写

在SQL里，关于应该如何区分使用大小写字母有着不成文的约定：关键字使用大写字母，列名和表名使用小写字母

```sql
    --√大小写有区分，易读
    SELECT  col_1, col_2, col_3,
            COUNT(＊)
      FROM  tbl_A
     WHERE  col_1 ='a'
      AND  col_2 = ( SELECT MAX(col_2)
                        FROM tbl_B
                      WHERE col_3 = 100 )
     GROUP BY  col_1, col_2, col_3;
```

```sql
    --×大小写没有区分，难读：全是小写
    select  col_1,  col_2,  col_3,
            count(＊)
      from  tbl_a
     where  col_1 ='a'
      and  col_2 = ( select max(col_2)
                        from tbl_b
                      where col_3 = 100 )
     group by  col_1, col_2, col_3;
```

```sql
    --×大小写没有区分，难读：全是大写
    SELECT  COL_1,  COL_2,  COL_3,
              COUNT(＊)
      FROM  TBL_A
     WHERE  COL_1 ='A'
      AND  COL_2 = ( SELECT MAX(COL_2)
                        FROM TBL_B
                      WHERE COL_3 = 100 )
     GROUP BY  COL_1, COL_2, COL_3;
```

## 逗号

前置逗号

```sql
    SELECT     col_1
            ,  col_2
            ,  col_3
            ,  col_4
      FROM  tbl_A;
```

> 这种写法有优点有缺点, 这里列出仅供参考

## 不使用通配符

写出所需的字段

```sql
    ×   SELECT ＊ FROM SomeTable;
    √   SELECT col_1, col2, col3 ... FROM SomeTable;
```

## ORDER BY中不使用列编号

前面讲过的通配符一样，一般来说会受列的顺序和位置影响的写法都应该避免

```sql
    ×   SELECT col_1, col2 FROM SomeTable ORDER BY 1, 2;
    √   SELECT col_1, col2 FROM SomeTable ORDER BY col_1, col2;
```

# SQL编程方法

## 请说普通话

SQL是一种有多种方言的语言，各种数据库实现都为我们做了各种扩展, 在日常开发中养成使用标准语法的习惯, 避免影响移植性

1. 不使用依赖各种数据库实现的函数和运算符

很多依赖数据库实现的函数都是转换函数或字符串处理函数。不要使用这些函数：DECODE(Oracle)、IF(MySQL)、NVL(Oracle)、STUFF(SQL Server)等。
请使用CASE表达式或者COALESCE、NULLIF等标准函数代替它们。此外，像SIGN或ABS、REPLACE这些，虽然标准SQL没有定义它们，但是几乎所有的数据库都
实现了它们，所以使用一下也没关系。

2. 连接操作使用标准语法

在很早的时候，连接条件和普通的查询条件一样，都是写在WHERE子句里的。

```sql
    SELECT ＊
      FROM Foo F, Bar B
     WHERE F.state = B.state
      AND F.city =’东京’;
```

标准SQL使用INNER或CROSS等表明连接类型的关键字，连接条件可以使用ON子句分开写。

```sql
    --内连接，而且一眼就能看明白连接条件是F.state = B.state
    SELECT ＊
      FROM Foo F INNER JOIN Bar B
        ON F.state = B.state
     WHERE F.city =’东京’;
```

外连接请使用LEFT OUTER JOIN、RIGHT OUTER JOIN或者FULL OUTER JOIN来写。使用(+)运算符(Oracle)、＊=运算符(SQL Server)等依赖数据库实
现的写法会降低代码的可移植性，而且表达能力也有限，所以还是尽量避免吧。标准SQL中允许省略关键字OUTER，但是这个关键字便于我们理解它是外连接而非
内连接，所以还是写上吧。

## “左派”和“右派”

外连接有左连接、右连接和全连接三种类型。其中，左连接和右连接的表达能力是一样的，理论上讲使用哪个都可以。

在代码风格方面，左连接有一个优势：一般情况下表头都出现在左边。使用左边的表作为主表的话，SQL就能和执行结果在格式上保持一致。

一般表头都在左边

![](https://res.weread.qq.com/wrepub/epub_26211874_300)

表头在右边的话看起来有点奇怪

![](https://res.weread.qq.com/wrepub/epub_26211874_301)

## 从FROM子句开始写

大家在写SQL语句时，是按照什么顺序写的呢？笔者想，大部分人都会说是从SELECT子句开始写的。他们可能会觉得“SELECT子句在开头，难道不该从它开始写
吗？”

原因是SELECT子句是SQL语句中最后执行的部分，写的时候根本没有必要太在意。SQL中各部分的执行顺序是：FROM→WHERE→GROUP BY→HAVING→SELECT
(→ORDER BY)。严格地说，ORDER BY并不是SQL语句的一部分，因此可以排除在外。这样一来，SELECT就是最后才被执行的部分了。
