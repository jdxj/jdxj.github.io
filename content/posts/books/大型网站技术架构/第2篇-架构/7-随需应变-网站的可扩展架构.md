---
title: "7 随需应变: 网站的可扩展架构"
date: 2023-07-24T14:29:58+08:00
---

**扩展性（Extensibility）**

指对现有系统影响最小的情况下，系统功能可持续扩展或提升的能力。表现在系统基础设施稳定不需要经常变更，应用之间较少依赖和耦合，对需求变更可以敏捷响应。
它是系统架构设计层面的开闭原则（对扩展开放，对修改关闭），架构设计考虑未来功能扩展，当系统增加新功能时，不需要对现有系统的结构和代码进行修改。

**伸缩性（Scalability）**

指系统能够通过增加（减少）自身资源规模的方式增强（减少）自己计算处理事务的能力。如果这种增减是成比例的，就被称作线性伸缩性。在网站架构中，通常指利
用集群的方式增加服务器数量、提高系统的整体事务吞吐能力。

## 7.1 构建可扩展的网站架构

可以说，度量一个开发框架、设计模式、编程语言优劣的重要尺度就是衡量它是不是让软件开发过程和软件产品更加低耦合。

设计网站可扩展架构的核心思想是模块化，并在此基础之上，降低模块间的耦合性，提高模块的复用性。

在大型网站中，这些模块通过分布式部署的方式，独立的模块部署在独立的服务器（集群）上，从物理上分离模块之间的耦合关系，进一步降低耦合性提高复用性。

模块分布式部署以后具体聚合方式主要有分布式消息队列和分布式服务。

## 7.2 利用分布式消息队列降低系统耦合性

### 7.2.1 事件驱动架构

事件驱动架构（Event Driven Architecture）：通过在低耦合的模块之间传输事件消息，以保持模块的松散耦合，并借助事件消息的通信完成模块间合作

图7.1 利用消息队列实现的事件驱动架构

![](https://res.weread.qq.com/wrepub/epub_773202_79)

### 7.2.2 分布式消息队列

图7.2 分布式消息队列架构原理

![](https://res.weread.qq.com/wrepub/epub_773202_80)

在伸缩性方面，由于消息队列服务器上的数据可以看作是被即时处理的，因此类似于无状态的服务器，伸缩性设计比较简单。将新服务器加入分布式消息队列集群中，
通知生产者服务器更改消息队列服务器列表即可。

在可用性方面，为了避免消费者进程处理缓慢，分布式消息队列服务器内存空间不足造成的问题，如果内存队列已满，会将消息写入磁盘，消息推送模块在将内存队列
消息处理完以后，将磁盘内容加载到内存队列继续处理。

为了避免消息队列服务器宕机造成消息丢失，会将消息成功发送到消息队列的消息存储在消息生产者服务器，等消息真正被消息消费者服务器处理后才删除消息。在消
息队列服务器宕机后，生产者服务器会选择分布式消息队列服务器集群中其他的服务器发布消息。

## 7.3 利用分布式服务打造可复用的业务平台

如果说分布式消息队列通过消息对象分解系统耦合性，不同子系统处理同一个消息；那么分布式服务则通过接口分解系统耦合性，不同子系统通过相同的接口描述进行
服务调用。

图7.3 巨无霸系统示意图

![](https://res.weread.qq.com/wrepub/epub_773202_81)

巨无霸应用系统带来如下几点问题

- 编译、部署困难
- 代码分支管理困难
- 数据库连接耗尽
- 新增业务困难

解决方案就是拆分

- 纵向拆分：将一个大应用拆分为多个小应用，如果新增业务较为独立，那么就直接将其设计部署为一个独立的Web应用系统。
- 横向拆分：将复用的业务拆分出来，独立部署为分布式服务，新增业务只需要调用这些分布式服务，不需要依赖具体的模块代码，即可快速搭建一个应用系统，而模
  块内业务逻辑变化的时候，只要接口保持一致就不会影响业务程序和其他模块。

图7.4 业务及模块拆分独立部署的分布式服务架构

![](https://res.weread.qq.com/wrepub/epub_773202_82)

### 7.3.1 Web Service与企业级分布式服务

图7.5 WebService架构原理

![](https://res.weread.qq.com/wrepub/epub_773202_83)

### 7.3.2 大型网站分布式服务的需求与特点

- 负载均衡
- 失效转移
- 高效的远程通信
- 整合异构系统
- 对应用最少侵入
- 版本管理
- 实时监控

### 7.3.3 分布式服务框架设计

图7.6 分布式服务框架Dubbo的架构原理

![](https://res.weread.qq.com/wrepub/epub_773202_84)

## 7.4 可扩展的数据结构

无需修改表结构就可以新增字段呢？许多NoSQL数据库使用的ColumnFamily（列族）设计就是一个解决方案。ColumnFamily最早在Google的Bigtable中使用，
这是一种面向列族的稀疏矩阵存储格式

表7.1 ColumnFamily数据存储格式

![](https://res.weread.qq.com/wrepub/epub_773202_85)

使用支持ColumnFamily结构的NoSQL数据库，创建表的时候，只需要指定ColumnFamily的名字，无需指定字段（Column），可以在数据写入时再指定，通过这种
方式，数据表可以包含数百万的字段，使得应用程序的数据结构可以随意扩展。而在查询时，可以通过指定任意字段名称和值进行查询。

## 7.5 利用开放平台建设网站生态圈

图7.7 开放平台架构原理

![](https://res.weread.qq.com/wrepub/epub_773202_86)

- API 接口：是开放平台暴露给开发者使用的一组API，其形式可以是RESTful、WebService、RPC等各种形式。
- 协议转换：将各种API输入转换成内部服务可以识别的形式，并将内部服务的返回封装成API的格式。
- 安全：除了一般应用需要的身份识别、权限控制等安全手段，开放平台还需要分级的访问带宽限制，保证平台资源被第三方应用公平合理使用，也保护网站内部服务
  不会被外部应用拖垮。
- 审计：记录第三方应用的访问情况，并进行监控、计费等。
- 路由：将开放平台的各种访问路由映射到具体的内部服务。
- 流程：将一组离散的服务组织成一个上下文相关的新服务，隐藏服务细节，提供统一接口供开发者调用。

## 7.6 小结
