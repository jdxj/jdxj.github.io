---
title: "6 永无止境: 网站的伸缩性架构"
date: 2023-07-23T15:04:37+08:00
---

所谓网站的伸缩性是指不需要改变网站的软硬件设计，仅仅通过改变部署的服务器数量就可以扩大或者缩小网站的服务处理能力。

## 6.1 网站架构的伸缩性设计

### 6.1.1 不同功能进行物理分离实现伸缩

图6.1 通过物理分离实现服务器伸缩

![](https://res.weread.qq.com/wrepub/epub_773202_59)

纵向分离（分层后分离）：将业务处理流程上的不同部分分离部署，实现系统伸缩性

图6.2 通过纵向分离部署实现系统伸缩性

![](https://res.weread.qq.com/wrepub/epub_773202_60)

横向分离（业务分割后分离）：将不同的业务模块分离部署，实现系统伸缩性

图6.3 通过横向分离部署实现系统伸缩性

![](https://res.weread.qq.com/wrepub/epub_773202_61)

### 6.1.2 单一功能通过集群规模实现伸缩

集群伸缩性又可分为应用服务器集群伸缩性和数据服务器集群伸缩性。这两种集群由于对数据状态管理的不同，技术实现也有非常大的区别。而数据服务器集群也可分
为缓存数据服务器集群和存储数据服务器集群，这两种集群的伸缩性设计也不大相同。

## 6.2 应用服务器集群的伸缩性设计

图6.4 负载均衡实现应用服务器伸缩性

![](https://res.weread.qq.com/wrepub/epub_773202_62)

### 6.2.1 HTTP重定向负载均衡

图6.5 HTTP重定向负载均衡原理

![](https://res.weread.qq.com/wrepub/epub_773202_63)

不推荐

### 6.2.2 DNS域名解析负载均衡

图6.6 DNS域名解析负载均衡原理

![](https://res.weread.qq.com/wrepub/epub_773202_64)

大型网站总是部分使用DNS域名解析，利用域名解析作为第一级负载均衡手段，即域名解析得到的一组服务器并不是实际提供Web服务的物理服务器，而是同样提供负
载均衡服务的内部服务器，这组内部负载均衡服务器再进行负载均衡，将请求分发到真实的Web服务器上。

### 6.2.3 反向代理负载均衡

图6.7 反向代理负载均衡原理

![](https://res.weread.qq.com/wrepub/epub_773202_65)

反向代理服务器是所有请求和响应的中转站，其性能可能会成为瓶颈。

### 6.2.4 IP负载均衡

图6.8 IP负载均衡原理

![](https://res.weread.qq.com/wrepub/epub_773202_66)

关键在于真实物理Web服务器响应数据包如何返回给负载均衡服务器。

- 一种方案是负载均衡服务器在修改目的IP地址的同时修改源地址，将数据包源地址设为自身IP，即源地址转换（SNAT），这样Web服务器的响应会再回到负载均衡
  服务器；
- 另一种方案是将负载均衡服务器同时作为真实物理服务器集群的网关服务器，这样所有响应数据都会到达负载均衡服务器。

### 6.2.5 数据链路层负载均衡

图6.9 数据链路层负载均衡原理

![](https://res.weread.qq.com/wrepub/epub_773202_67)

用户请求到达负载均衡服务器114.100.80.10后，负载均衡服务器将请求数据的目的mac地址修改为00:0c:29:d2，并不修改数目包目标IP地址，由于Web服务器
集群所有服务器的虚拟IP地址都和负载均服务器的IP地址相同，因此数据可以正常传输到达mac地址00:0c:29:d2对应的服务器，该服务器处理完成后发送响应数据
到网站的网关服务器，**网关服务器直接将该数据包发送到用户浏览器**（通过互联网），响应数据不需要通过负载均衡服务器。

使用三角传输模式的链路层负载均衡是目前大型网站使用最广的一种负载均衡手段。在Linux平台上最好的链路层负载均衡开源产品是LVS（Linux Virtual Server）。

### 6.2.6 负载均衡算法

- 轮询（Round Robin，RR）
- 加权轮询（Weighted Round Robin，WRR）
- 随机（Random）
- 最少连接（Least Connections）
- 源地址散列（Source Hashing）

## 6.3 分布式缓存集群的伸缩性设计

和所有服务器都部署相同应用的应用服务器集群不同，分布式缓存服务器集群中不同服务器中缓存的数据各不相同

### 6.3.1 Memcached分布式缓存集群的访问模型

图6.10 Memcached分布式缓存访问模型

![](https://res.weread.qq.com/wrepub/epub_773202_68)

### 6.3.2 Memcached分布式缓存集群的伸缩性挑战

简单的hash在增加缓存服务器时导致命中率降低

### 6.3.3 分布式缓存的一致性Hash算法

图6.11 一致性Hash算法原理

![](https://res.weread.qq.com/wrepub/epub_773202_69)

图6.12 增加节点后的一致性Hash环结构

![](https://res.weread.qq.com/wrepub/epub_773202_70)

解决上述一致性Hash算法带来的负载不均衡问题，也可以通过使用虚拟层的手段：将每台物理缓存服务器虚拟为一组虚拟缓存服务器，将虚拟服务器的Hash值放置在
Hash环上，KEY在环上先找到虚拟服务器节点，再得到物理服务器的信息。

图6.13 使用虚拟节点的一致性Hash环

![](https://res.weread.qq.com/wrepub/epub_773202_71)

## 6.4 数据存储服务器集群的伸缩性设计

### 6.4.1 关系数据库集群的伸缩性设计

市场上主要的关系数据都支持数据复制功能，使用这个功能可以对数据库进行简单伸缩。

图6.14 MySQL集群伸缩性方案

![](https://res.weread.qq.com/wrepub/epub_773202_72)

除了数据库主从读写分离，前面提到的业务分割模式也可以用在数据库，不同业务数据表部署在不同的数据库集群上，即俗称的数据分库。这种方式的制约条件是跨库
的表不能进行Join操作。

数据库分片, 将一张表拆开分别存储在多个数据库中。

图6.15 Cobar部署模型

![](https://res.weread.qq.com/wrepub/epub_773202_73)

应用程序通过JDBC驱动访问Cobar集群，Cobar服务器根据SQL和分库规则分解SQL，分发到MySQL集群不同的数据库实例上执行（每个MySQL实例都部署为主/从结
构，保证数据高可用）。

图6.16 Cobar系统组件模型

![](https://res.weread.qq.com/wrepub/epub_773202_74)

### 6.4.2 NoSQL数据库的伸缩性设计

大型网站遇到了关系数据库难以克服的缺陷——糟糕的海量数据处理能力及僵硬的设计约束

NoSQL，主要指非关系的、分布式的数据库设计模式。也有许多专家将NoSQL解读为Not Only SQL，表示NoSQL只是关系数据库的补充，而不是替代方案。一般而言，
NoSQL数据库产品都放弃了关系数据库的两大重要基础：以关系代数为基础的结构化查询语言（SQL）和事务一致性保证（ACID）。而强化其他一些大型网站更关注的
特性：高可用性和可伸缩性。

应用最广泛的是Apache HBase

HBase为可伸缩海量数据储存而设计，实现面向在线业务的实时数据访问延迟。HBase的伸缩性主要依赖其可分裂的HRegion及可伸缩的分布式文件系统HDFS实现。

图6.19 HBase架构

![](https://res.weread.qq.com/wrepub/epub_773202_77)

HBase中，数据以HRegion为单位进行管理，也就是说应用程序如果想要访问一个数据，必须先找到HRegion，然后将数据读写操作提交给HRegion，由HRegion完
成存储层面的数据操作。每个HRegion中存储一段Key值区间[key1,key2)的数据，HRegionServer是物理服务器，每个HRegionServer上可以启动多个
HRegion实例。当一个HRegion中写入的数据太多，达到配置的阈值时，HRegion会分裂成两个HRegion，并将HRegion在整个集群中进行迁移，以使
HregionServer的负载均衡。

所有HRegion的信息（存储的Key值区间、所在HRegionServer地址、访问端口号等）都记录在HMaser服务器上，为了保证高可用，HBase启动多个HMaser，并
通过Zookeeper（一个支持分布式一致性的数据管理服务）选举出一个主服务器，应用程序通过Zookeeper获得主HMaser的地址，输入Key值获得这个Key所在的
HRegionServer地址，然后请求HRegionServer上的HRegion，获得需要的数据。

图6.20 HBase数据寻址过程时序图

![](https://res.weread.qq.com/wrepub/epub_773202_78)

## 6.5 小结
