---
title: "5 万无一失: 网站的高可用架构"
date: 2023-07-23T09:52:13+08:00
---

## 5.1 网站可用性的度量与考核

### 5.1.1 网站可用性度量

业界通常用多少个9来衡量网站的可用性

- 网站不可用时间（故障时间）=故障修复时间点-故障发现（报告）时间点
- 网站年度可用性指标=（1-网站不可用时间/年度总时间）×100%

- 对于大多数网站而言，2个9是基本可用，网站年度不可用时间小于88小时；
- 3个9是较高可用，网站年度不可用时间小于9小时；
- 4个9是具有自动恢复能力的高可用，网站年度不可用时间小于53分钟；
- 5个9是极高可用性，网站年度不可用时间小于5分钟。

### 5.1.2 网站可用性考核

可用性指标是网站架构设计的重要指标，对外是服务承诺，对内是考核指标。从管理层面，可用性指标是网站或者产品的整体考核指标，具体到每个工程师的考核，更
多的是使用故障分。

- 故障分是指对网站故障进行分类加权计算故障责任的方法。
- 故障分=故障时间（分钟）× 故障权重

表5.1 网站故障分类权重表示例

![](https://res.weread.qq.com/wrepub/epub_773202_40)

不同的公司有不同的企业文化和市场策略，这些因素也会影响到系统可用性的架构决策

## 5.2 高可用的网站架构

实现高可用架构的主要手段是数据和服务的冗余备份及失效转移，一旦某些服务器宕机，就将服务切换到其他可用的服务器上，如果磁盘损坏，则从备份的磁盘读取数
据。

图5.2 网站架构基本分层模型

![](https://res.weread.qq.com/wrepub/epub_773202_42)

- 应用层主要负责具体业务逻辑处理；
- 服务层负责提供可复用的服务；
- 数据层负责数据的存储与访问。

图5.3 应用和数据分离部署的网站架构

![](https://res.weread.qq.com/wrepub/epub_773202_43)

在复杂的大型网站架构中，划分的粒度会更小、更详细，结构更加复杂，服务器规模更加庞大，但通常还是能够把这些服务器划分到这三层中。

图5.4 分层后按模块分割的网站架构模型

![](https://res.weread.qq.com/wrepub/epub_773202_44)

网站的可用性架构设计不但要考虑实际的硬件故障引起的宕机，还要考虑网站升级发布引起的宕机，而后者更加频繁，不能因为系统可以接受偶尔的停机故障就降低可
用性设计的标准。

## 5.3 高可用的应用

无状态设计

### 5.3.1 通过负载均衡进行无状态服务的失效转移

对于应用服务器集群，实现这种服务器可用状态实时监测、自动转移失败任务的机制是负载均衡。

图5.5 利用负载均衡服务器实现高可用的应用服务

![](https://res.weread.qq.com/wrepub/epub_773202_45)

### 5.3.2 应用服务器集群的Session管理

集群环境下，Session管理主要有以下几种手段

**Session复制**

适用于较小的集群规模

应用服务器开启Web容器的Session复制功能，在集群中的几台服务器之间同步Session对象，使得每台服务器上都保存所有用户的Session信息，这样任何一台机
器宕机都不会导致Session数据的丢失，而服务器使用Session时，也只需要在本机获取即可。

图5.6 使用Session复制实现应用服务器共享Session

![](https://res.weread.qq.com/wrepub/epub_773202_46)

**Session绑定**

很少有网站利用这个算法进行Session管理

Session绑定可以利用负载均衡的源地址Hash算法实现，负载均衡服务器总是将来源于同一IP的请求分发到同一台服务器上, 保证Session总能在这台服务器上获取。
这种方法又被称作会话黏滞

图5.7 利用负载均衡的会话黏滞机制将请求绑定到特定服务器

![](https://res.weread.qq.com/wrepub/epub_773202_47)

**利用Cookie记录Session**

将Session记录在客户端，每次请求服务器的时候，将Session放在请求中发送给服务器，服务器处理完请求后再将修改过的Session响应给客户端。

图5.8 利用Cookie记录Session信息

![](https://res.weread.qq.com/wrepub/epub_773202_48)

缺点

- cookie大小有限制
- 每次都传输cookie, 影响性能
- 用户可以关闭cookie功能

**Session服务器**

利用独立部署的Session服务器（集群）统一管理Session，应用服务器每次读写Session时，都访问Session服务器

图5.9 利用Session服务器共享Session

![](https://res.weread.qq.com/wrepub/epub_773202_49)

## 5.4 高可用的服务

可复用的服务和应用一样，也是无状态的服务，因此可以使用类似负载均衡的失效转移策略实现高可用的服务。

具体实践中，还有以下几点高可用的服务策略。

**分级管理**

- 运维上将服务器进行分级管理，核心应用和服务优先使用更好的硬件，在运维响应速度上也格外迅速。
- 服务部署上也进行必要的隔离，避免故障的连锁反应。

**超时设置**

由于服务端宕机、线程死锁等原因，可能导致应用程序对服务端的调用失去响应，进而导致用户请求长时间得不到响应，同时还占用应用程序的资源，不利于及时将访
问请求转移到正常的服务器上。

**异步调用**

- 应用对服务的调用通过消息队列等异步方式完成，避免一个服务失败导致整个应用请求失败的情况。
- 对于那些必须确认服务调用成功才能继续下一步操作的应用也不合适使用异步调用。

**服务降级**

- 拒绝服务：拒绝低优先级应用的调用，减少服务调用并发数，确保核心应用正常使用；或者随机拒绝部分请求调用，节约资源，让另一部分请求得以成功
- 关闭功能：关闭部分不重要的服务，或者服务内部关闭部分不重要的功能，以节约系统开销，为重要的服务和功能让出资源。

**幂等性设计**

虚假失败

服务重复调用是无法避免的，应用层也不需要关心服务是否真的失败，只要没有收到调用成功的响应，就可以认为调用失败，并重试服务调用。因此必须在服务层保证
服务重复调用和调用一次产生的结果相同，即服务具有幂等性。

## 5.5 高可用的数据

保证数据存储高可用的手段主要是数据备份和失效转移机制。

- 数据备份是保证数据有多个副本，任意副本的失效都不会导致数据的永久丢失，从而实现数据完全的持久化。
- 失效转移机制则保证当一个数据副本不可访问时，可以快速切换访问数据的其他副本，保证系统可用。

对缓存可用性的两种观点

- 缓存已经成为网站数据服务的重要组成部分，事实上承担了业务中绝大多数的数据读取访问服务，缓存服务失效可能会导致数据库负载过高而宕机，进而影响整个网
  站的可用性，因此缓存服务需要实现和数据存储服务同样的高可用。
- 缓存服务不是数据存储服务，缓存服务器宕机引起缓存数据丢失导致服务器负载压力过高应该通过其他手段解决，而不是提高缓存服务本身的高可用。

### 5.5.1 CAP原理

图5.10 CAP原理

![](https://res.weread.qq.com/wrepub/epub_773202_50)

在大型网站应用中，数据规模总是快速扩张的，因此可伸缩性即分区耐受性必不可少，规模变大以后，机器数量也会变得庞大，这时网络和服务器故障会频繁出现，要
想保证应用可用，就必须保证分布式处理系统的高可用性。所以在大型网站中，通常会选择强化分布式存储系统的可用性（A）和伸缩性（P），而在某种程度上放弃一
致性（C）。

数据一致性又可分为如下几点

**数据强一致**

各个副本的数据在物理存储中总是一致的；数据更新操作结果和操作响应总是一致的，即操作响应通知更新失败，那么数据一定没有被更新，而不是处于不确定状态。

**数据用户一致**

即数据在物理存储中的各个副本的数据可能是不一致的，但是终端用户访问时，通过纠错和校验机制，可以确定一个一致的且正确的数据返回给用户。

**数据最终一致**

这是数据一致性中较弱的一种，即物理存储的数据可能是不一致的，终端用户访问到的数据可能也是不一致的（同一用户连续访问，结果不同；或者不同用户同时访问，
结果不同），但系统经过一段时间（通常是一个比较短的时间段）的自我恢复和修正，数据最终会达到一致。

### 5.5.2 数据备份

数据冷备，即定期将数据复制到某种存储介质（磁带，光盘……）上并物理存档保管，如果系统存储损坏，那么就从冷备的存储设备中恢复数据。

- 冷备的优点是简单和廉价，成本和技术难度都较低。
- 缺点是不能保证数据最终一致，由于数据是定期复制，因此备份设备中的数据比系统中的数据陈旧. 同时也不能保证数据可用性，从冷备存储中恢复数据需要较长的
  时间，而这段时间无法访问数据，系统也不可用。

数据热备可分为两种：异步热备方式和同步热备方式。

- 异步方式是指多份数据副本的写入操作异步完成，应用程序收到数据服务系统的写操作成功响应时，只写成功了一份，存储系统将会异步地写其他副本（这个过程有
  可能会失败）。

图5.11 数据异步热备

![](https://res.weread.qq.com/wrepub/epub_773202_51)

- 同步方式是指多份数据副本的写入操作同步完成，即应用程序收到数据服务系统的写成功响应时，多份数据都已经写操作成功。但是当应用程序收到数据写操作失败
  的响应时，可能有部分副本或者全部副本都已经写成功了（因为网络或者系统故障，无法返回操作成功的响应）
  - 同步热备具体实现的时候，为了提高性能，在应用程序客户端并发向多个存储服务器同时写入数据，然后等待所有存储服务器都返回操作成功的响应后，再通知
    应用程序写操作成功。

图5.12 数据同步热备

![](https://res.weread.qq.com/wrepub/epub_773202_52)

关系数据库热备机制就是通常所说的Master-Slave同步机制。实践中，通常使用读写分离的方法访问Slave和Master数据库，写操作只访问Master数据库，读操
作只访问Slave数据库。

### 5.5.3 失效转移

失效转移操作由三部分组成：失效确认、访问转移、数据恢复。

**1. 失效确认**

系统确认一台服务器是否宕机的手段有两种：心跳检测和应用程序访问失败报告

图5.13 存储服务器失效确认

![](https://res.weread.qq.com/wrepub/epub_773202_53)

**2. 访问转移**

确认某台数据存储服务器宕机后, 当其中一台宕机后，应用程序根据配置直接切换到对等服务器上。如果存储是不对等的，那么就需要重新计算路由，选择存储服务器。

**3. 数据恢复**

因为某台服务器宕机，所以数据存储的副本数目会减少，必须将副本的数目恢复到系统设定的值，否则，再有服务器宕机时，就可能出现无法访问转移（所有副本的服
务器都宕机了），数据永久丢失的情况。

## 5.6 高可用网站的软件质量保证

一些与传统软件开发不同的质量保证手段

### 5.6.1 网站发布

网站的发布过程事实上和服务器宕机效果相当, 由于应用的不断发布，用户需要面对的是每周一到两次的宕机故障。

图5.14 网站应用发布流程

![](https://res.weread.qq.com/wrepub/epub_773202_54)

发布过程中，每次关闭的服务器都是集群中的一小部分，并在发布完成后立即可以访问，因此整个发布过程不影响用户使用。

### 5.6.2 自动化测试

- 对整个网站功能进行全面的回归测试。
- 需要测试各种浏览器的兼容性

Selenium工具

### 5.6.3 预发布验证

即使是经过严格的测试，软件部署到线上服务器之后还是经常会出现各种问题, 因此在网站发布时，并不是把测试通过的代码包直接发布到线上服务器，而是先发布到
预发布机器上，开发工程师和测试工程师在预发布服务器上进行预发布验证，执行一些典型的业务流程，确认系统没有问题后才正式发布。

预发布服务器是一种特殊用途的服务器，它和线上的正式服务器唯一的不同就是没有配置在负载均衡服务器上，外部用户无法访问

图5.15 网站应用预发布

![](https://res.weread.qq.com/wrepub/epub_773202_55)

在预发布机器上进行测试所产生的测试数据可能会暴露给用户

快速失败（fast failed）即如果系统在启动时发现问题就立刻抛出异常，停止启动让工程师介入排查错误，而不是启动后执行错误的操作。

### 5.6.4 代码控制

网站代码控制的核心问题是如何进行代码管理，既能保证代码发布版本的稳定正确，同时又能保证不同团队的开发互不影响。

### 5.6.5 自动化发布

很多网站选择周四作为发布日，这样一周前面有三天时间可以准备发布，后面还有一天时间可以挽回错误。如果选择周五发布，发现问题就必须要周末加班了。

图5.17 网站火车发布模型

![](https://res.weread.qq.com/wrepub/epub_773202_57)

由于火车发布模型是基于规则驱动的流程，所以这个流程可以自动化。

### 5.6.6 灰度发布

应用发布成功后，仍然可能发现因为软件问题而引入的故障，这时候就需要做发布回滚，即卸载刚刚发布的软件，将上一个版本的软件包重新发布，使系统复原，消除
故障。

大型网站会使用灰度发布模式，将集群服务器分成若干部分，每天只发布一部分服务器，观察运行稳定没有故障，第二天继续发布一部分服务器，持续几天才把整个集
群全部发布完毕，期间如果发现问题，只需要回滚已发布的一部分服务器即可。

图5.18 网站灰度发布模型

![](https://res.weread.qq.com/wrepub/epub_773202_58)

灰度发布也常用于用户测试，即在部分服务器上发布新版本，其余服务器保持老版本（或者发布另一个版本），然后监控用户操作行为，收集用户体验报告，比较用户
对两个版本的满意度，以确定最终的发布版本。这种手段也被称作AB测试。

## 5.7 网站运行监控

### 5.7.1 监控数据采集

- 用户行为日志收集
  - 服务器端日志收集
  - 客户端浏览器日志收集
- 服务器性能监控
- 运行数据报告. 缓冲命中率、平均响应延迟时间、每分钟发送邮件数目、待处理的任务总数等。

### 5.7.2 监控管理

- 系统报警
- 失效转移
- 自动优雅降级

## 5.8 小结

对公司而言，可用性关系网站的生死存亡。对个人而言，可用性关系到自己的绩效升迁。工程师对架构做了许多优化、对代码做了很多重构，对性能、扩展性、伸缩性
做了很多改善，但别人未必能直观地感受到，也许你的直接领导都不知道你做的这些意义何在。但如果你负责的产品出了重大故障，CEO都会知道你的名字。事物总是
先求生存，然后求发展。保证网站可用，万无一失，任重而道远。
