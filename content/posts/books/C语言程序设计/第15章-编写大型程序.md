---
title: "第15章 编写大型程序"
date: 2023-07-06T15:58:33+08:00
---

## 15.1 源文件

根据惯例，源文件的扩展名为.c。

## 15.2 头文件

#include指令，此指令使得在任意数量的源文件中共享信息成为可能，这些信息可以是函数原型、宏定义、类型定义等。

根据惯例，头文件的扩展名为.h。

### 15.2.1 #include指令

第一种格式用于属于C语言自身库的头文件

```c
#include <文件名>
```

第二种格式用于所有其他头文件，也包含任何自己编写的文件

```c
#include "文件名"
```

- #include <文件名>：搜寻系统头文件所在的目录（或多个目录）。（例如，在UNIX系统中，通常把系统头文件保存在目录/usr/include中。）
- #include "文件名"：先搜寻当前目录，然后搜寻系统头文件所在的目录（或多个目录）。

在#include指令中的文件名可以含有帮助定位文件的信息，比如目录的路径或驱动器号：

```c
// 不推荐带路径
#include "c:\cprogs\utils.h"     /* Windows path */
#include "/cprogs/utils.h"       /* UNIX path */
```

#include指令还有一种不太常用的格式

```c
#include 记号
```

```c
#if defined(IA32)
  #define CPU_FILE "ia32.h"
#elif defined(IA64)
  #define CPU_FILE "ia64.h"
#elif defined(AMD64)
  #define CPU_FILE "amd64.h"
#endif
#include CPU_FILE
```

### 15.2.2 共享宏定义和类型定义

```c
#define BOOL int
#define TRUE 1
#define FALSE 0

// 任何需要这些宏的源文件只需简单包含下面这一行
#include "boolean.h"
```

类型定义在头文件中也是很普遍的。

```c
#define TRUE 1
#define FALSE 0
typedef int Bool;
```

### 15.2.3 共享函数原型

既然在文件foo.c中定义了函数f，我们把头文件命名为foo.h。除了在调用函数f的源文件中包含foo.h，还需要在foo.c中包含它，从而使编译器可以验证
foo.h中函数f的原型和foo.c中f的函数定义相匹配。

stack.h

```c
void make_empty(void);
int is_empty (void);
int is_full (void);
void push(int i);
int pop (void);
```

文件calc.c中将包含stack.h以便编译器检查在后面的文件中出现的栈函数的任何调用。文件stack.c中也将包含stack.h以便编译器验证stack.h中的函数
原型是否与stack.c中的定义相匹配。

![](https://res.weread.qq.com/wrepub/epub_31359737_630)

### 15.2.4 共享变量声明

声明也是定义变量

```c
int i;               /* declares i and defines it as well */
```

声明变量

```c
extern int i;        /* declares i without defining it */
```

extern告诉编译器，变量i是在程序中的其他位置定义的（很可能是在不同的源文件中），因此不需要为i分配空间。

extern可以用于所有类型的变量。在数组的声明中使用extern时，可以省略数组的长度：

```c
extern int a[];
```

为了避免不一致，通常把共享变量的声明放置在头文件中。需要访问特定变量的源文件可以包含相应的头文件。此外，含有变量定义的源文件需要包含含有相应
变量声明的头文件，这样编译器就可以检查声明与定义是否匹配。

### 15.2.5 嵌套包含

头文件自身也可以包含#include指令。

### 15.2.6 保护头文件

两次包含同一个头文件不总是会导致编译错误。如果文件只包含宏定义、函数原型和/或变量声明，那么将不会有任何困难。然而，如果文件包含类型定义，则会
带来编译错误。

此外，在程序开发期间，避免同一个头文件的不必要重复编译可以节省一些时间。

为了防止头文件多次包含，用#ifndef和#endif指令来封闭文件的内容。

```c
#ifndef BOOLEAN_H
#define BOOLEAN_H
#define TRUE 1
#define FALSE 0
typedef int Bool;
#endif
```

### 15.2.7 头文件中的#error指令

```c
#ifndef __STDC__
#error This header requires a Standard C compiler
#endif
```

## 15.3 把程序划分成多个文件

## 15.4 构建多文件程序

```c
gcc -o justify justify.c line.c word.c
```

### 15.4.1 makefile

### 15.4.2 链接期间的错误

### 15.4.3 重新构建程序

### 15.4.4 在程序外定义宏

```c
gcc -DDEBUG=1 foo.c
```

如果-D选项命名的宏没有指定值，那么这个值被设为1。

许多编译器也支持-U选项，这个选项用于删除宏的定义，效果相当于#undef。
