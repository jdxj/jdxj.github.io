---
title: "swap"
date: 2023-09-29T13:43:10+08:00
---

可回收的内存

- 文件页: buffer, cache
- 匿名页: 应用程序动态分配的堆内存

现在的内存便宜多了，服务器一般也会配置很大的内存，那是不是说 Swap 就没有用武之地了呢？

- 一个很典型的场景就是，即使内存不足时，有些应用程序也并不想被 OOM 杀死，而是希望能缓一段时间，等待人工介入，或者等系统自动释放其他进程的内
  存，再分配给它。
- 笔记本电脑的休眠和快速开机的功能，也基于 Swap 。休眠时，把系统的内存存入磁盘，这样等到再次开机时，只要从磁盘中加载内存就可以。这样就省去了
  很多应用程序的初始化过程，加快了开机速度。

Swap 是为了回收内存，那么 Linux 到底在什么时候需要回收内存呢？

- 有新的大块内存分配请求，但是剩余内存不足。直接内存回收
- 专门的内核线程用来定期回收内存，也就是 kswapd0

kswapd0 定义了三个内存阈值（watermark，也称为水位），分别是页最小阈值（pages_min）、页低阈值（pages_low）和页高阈值（pages_high）。
剩余内存，则使用 pages_free 表示。

![](https://static001.geekbang.org/resource/image/c1/20/c1054f1e71037795c6f290e670b29120.png?wh=350*233)

# swappiness

- 对文件页的回收，当然就是直接回收缓存，或者把脏页写回磁盘后再回收。
- 对匿名页的回收，其实就是通过 Swap 机制，把它们写入磁盘后再释放内存。

swappiness 用来调整使用 Swap 的积极程度。

- swappiness 的范围是 0-100，数值越大，越积极使用 Swap，也就是更倾向于回收匿名页；数值越小，越消极使用 Swap，也就是更倾向于回收文件页。
- 即使你把它设置成 0，当剩余内存 + 文件页小于页高阈值时，还是会发生 Swap。