---
title: "第4章 HTTP/2协议基础"
date: 2023-03-21T21:26:37+08:00
draft: true
---

## 4.1 为什么是HTTP/2而不是HTTP/1.2

新版本的协议与原来的协议有很大的不同，新增了如下概念：

- 二进制协议
- 多路复用
- 流量控制功能
- 数据流优先级
- 首部压缩
- 服务端推送

HTTP/1.0的Web服务器可以支持HTTP/1.1的消息，并可以忽略后来的版本中新增的功能，但在HTTP/2中，就不能兼容了，HTTP/2使用了不同的数据结构和格式。
出于这个原因，HTTP/2被视为主版本更新。

HTTP/2.0还是HTTP/2

- HTTP/2定义了新版本HTTP的主要部分（二进制、多路复用等），并且未来的任何实现或变更（如果有HTTP/2.1的话），此规范都兼容。

> 所以小版本号不太重要.

- 此外，与HTTP/1消息不同，在HTTP/2请求中未明确声明版本号。
  - 例如，HTTP/2中没有GET /index.html HTTP/1.1形式的请求。
  - 但是，许多实现会在日志文件中使用次要版本号（.0）。例如，在Apache日志文件中，版本号显示为HTTP/2.0，其甚至会伪造HTTP/1形式的请求

![](https://res.weread.qq.com/wrepub/epub_32517945_78)

### 4.1.1 使用二进制格式替换文本格式

使用基于文本的协议，要先发完请求，并接收完响应之后，才能开始下一个请求。

HTTP的小改进

- HTTP/1.0引入了二进制的HTTP消息体，支持在响应中发送图片或其他媒体文件。
- HTTP/1.1引入了管道化和分块编码。
  - 都有队头阻塞（HOL）的问题——在队列首部的消息会阻塞后面消息的发送，更不用说，管道化在实际应用中并没有得到很好的支持。

### 4.1.2 多路复用代替同步请求

HTTP/1是一种同步的、独占的请求-响应协议。HTTP/1的主要解决方法是打开多个连接，并且使用资源合并以减少请求数，但这两种解决方法都会引入其他的问题和
带来性能开销。

图4.1　并发多个HTTP/1请求，需要多个TCP连接

![](https://res.weread.qq.com/wrepub/epub_32517945_79)

HTTP/2允许在单个连接上同时执行多个请求，每个HTTP请求或响应使用不同的流。通过使用二进制分帧层，给每个帧分配一个流标识符，以支持同时发出多个独立请
求。当接收到该流的所有帧时，接收方可以将帧组合成完整消息。

图4.2　使用多路复用技术的HTTP/2连接请求三个资源

![](https://res.weread.qq.com/wrepub/epub_32517945_80)

- **HTTP/2连接在请求发出后不需要阻塞到响应返回**
- 服务器发送响应的顺序完全取决于服务器，但客户端可以指定优先级。
- 每个请求都有一个新的、自增的流ID（如图4.2中所示的流5、7和9）。返回响应时使用相同的流ID
- 响应完成后，流会被丢弃而且不能重用
- 为了防止流ID冲突，客户端发起的请求使用奇数流ID, 服务器发起的请求使用偶数流ID。
- 请注意，在写作本书时，从技术上讲**服务器不能新建一个流**，除非是特殊情况（服务端推送，但也要客户端先发起请求）
- ID为0的流（图中未显示出）是客户端和服务器用于管理连接的控制流。

小结

- HTTP/2使用多个二进制帧发送HTTP请求和响应，使用单个TCP连接，以流的方式多路复用。
- HTTP/2与HTTP/1的不同主要在消息发送的层面上，在更上层，HTTP的核心概念不变。例如，请求包含一个方法（例如GET）、想要获取的资源
  （例如/styles.css）、首部、正文、状态码（例如200、404）、缓存、Cookie等，这些都与HTTP/1保持一致。

图4.3　HTTP/2中的流和HTTP/1中的连接相似

![](https://res.weread.qq.com/wrepub/epub_32517945_81)

### 4.1.3 流的优先级和流量控制

现在HTTP/2对并发的请求数量的限制放宽了很多（在许多实现中，默认情况下允许同时存在100个活跃的流），因此许多请求不再需要浏览器来排队，可以立即发送它
们。这可能导致带宽浪费在较低优先级的资源（例如图像）上，从而导致在HTTP/2下页面的加载速度变慢。所以需要控制流的优先级，使用更高的优先级发送最关键
的资源。

流的优先级控制是通过这种方式实现的：当数据帧在排队时，服务器会给高优先级的请求发送更多的帧。

流量控制是在同一个连接上使用多个流的另一种方式。如果接收方处理消息的速度慢于发送方，就会存在积压，需要将数据放入缓冲区。而当缓冲区满时会导致丢包，
需要重新发送。在连接层，TCP支持限流，但HTTP/2要在流的层面实现流量控制。

### 4.1.4 首部压缩

HTTP首部（包括请求首部和响应首部）用于发送与请求和响应相关的额外信息。在这些首部中，有很多信息是重复的，多个资源使用的首部经常相同。

- Cookie
- User-Agent
- Host
- Accept
- Accept-Encoding

### 4.1.5 服务端推送

HTTP/2添加了服务端推送的概念，它**允许服务端给一个请求返回多个响应**。

HTTP/2服务端推送是HTTP协议中的新概念，如果使用不当，它很容易浪费带宽。浏览器并不需要推送的资源，特别是，在之前已经请求过的服务器推送的资源，放在
浏览器缓存中。决定什么时候推送、如何推送，是充分利用服务端推送的关键。
