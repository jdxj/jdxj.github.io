---
title: "第7章 高级HTTP/2概念"
date: 2023-03-27T21:19:09+08:00
draft: true
---

## 7.1 流状态

图7.1　可以使用类似的方式表述HTTP/1.1的连接和HTTP/2的流

![](https://res.weread.qq.com/wrepub/epub_32517945_234)

HTTP/2的流会经过一些生命周期状态。客户端发送HEADERS帧以开启一个HTTP请求，服务器响应此请求，然后流结束。这个过程经历如下状态

- 空闲。流刚被创建或者引用时的状态。实际上，大多数流处在这个状态的时间都很短，因为如果不想使用一个流，你也不会引用它，所以大多空闲的流会被直接使用，
  然后直接进入下一个状态：打开。
- 打开。当流被用以发送HEADERS帧时，就是打开的状态，此时流可以用来做双向的消息传递。只要客户端还在发送数据，流都保持在这个状态。
- 半关闭。当客户端使用END_STREAM标志位，表明请求的HEADERS帧已经包含了请求的所有数据时，流就变成半关闭的状态，此时流只能被用来给客户端发送响应
  数据，客户端不能使用它再发送数据（除非像WINDOW_UPDATE这种控制帧）。
- 关闭。当服务器完成数据发送，并在最后一个帧上使用END_STREAM标志时，流就变成关闭状态，此时不可以再使用流。

不会有新的帧由服务端发起）。这时，一个流启动另外一个流（使用承诺的流ID），这个新的承诺的流会经过一个类似的状态流转过程(服务端推送)

- 空闲。当承诺（要推送）的流最初被创建，或者被另外一个流上的PUSH_PROMISE帧引用的时候的状态。
- 保留。推送流直接进入保留状态，直到服务器准备好要推送的资源。
- 半关闭。当服务器开始推送响应时，承诺的（推送）流进入半关闭状态，流只能用于发送推送的数据。
- 关闭。当服务器发送完数据，在最后一个DATA帧上使用END_STREAM标志时，流会变成关闭状态，此时不能再使用流。

图7.2　HTTP/2流状态

![](https://res.weread.qq.com/wrepub/epub_32517945_235)

## 7.2 流量控制

当接收方没有准备好处理数据时（可能是因为忙而无法处理数据），可以使用流量控制来停止发送方的数据发送。进行流量控制是非常有必要的，因为这样可以让客户
端以不同的速度处理数据。高速的服务器或许可以快速地发送数据，但如果低速的客户端（如手机）跟不上它的速度，它会在内存中缓存数据，当缓存区满了的时候，
它就开始丢弃数据包，并要求服务端重发。这就导致服务端、网络和客户端浪费一些资源。

### 7.2.1 流量控制示例

![](https://res.weread.qq.com/wrepub/epub_32517945_236)

在两个SETTINGS帧中间，出现第一个WINDOW_UPDATE帧

![](https://res.weread.qq.com/wrepub/epub_32517945_237)

这个帧说明，Facebook准备接收10 420 225个8位字节，因为这个帧使用的流ID为0，所以这是会应用到所有流的连接层的限制

然后nghttp确认收到服务端的设置

![](https://res.weread.qq.com/wrepub/epub_32517945_238)

首个请求使用HEADERS帧发送，并使用流ID 13：

![](https://res.weread.qq.com/wrepub/epub_32517945_239)

然后服务端确认收到SETTTINGS帧，之后使用另外一个WINDOW_UPDATE帧将流13的窗口大小增加到10 420 224个8位字节

![](https://res.weread.qq.com/wrepub/epub_32517945_240)

nghttp开始接收资源的HEADERS和DATA帧

![](https://res.weread.qq.com/wrepub/epub_32517945_241)

把这些DATA帧的大小加起来（1353 + 2571 + 8144 + 5563 + 2572 +1491+ 2581 + 4072 + 5572），结果是33 919，所以nghttp告诉服务器它在连接
层（流ID为0）和流13上已经消费掉了这么多数据

![](https://res.weread.qq.com/wrepub/epub_32517945_242)

客户端通过一个非常友好的GOAWAY帧关闭连接：

![](https://res.weread.qq.com/wrepub/epub_32517945_243)

### 7.2.2 在服务器上设置流量控制

## 7.3 流优先级

