---
title: "第2章 通向http2之路"
date: 2023-03-18T11:23:11+08:00
draft: true
---

## 2.1 HTTP/1.1和当前的万维网

图2.1　网站加载内容平均大小（2014年—2018年）

![](https://res.weread.qq.com/wrepub/epub_32517945_37)

表2.1　美国访问量排名前10网站

![](https://res.weread.qq.com/wrepub/epub_32517945_38)

### 2.1.1 HTTP/1.1根本的性能问题

图2.2　在一个简单的网站示例中，HTTP请求及响应的流程

![](https://res.weread.qq.com/wrepub/epub_32517945_39)

- 处理时间在整个请求流程中占比很小, 大部分时间都在等待, 效率低
- 现代互联网最大的问题之一是延迟而不是带宽。

### 2.1.2 HTTP/1.1管道化

图2.3　简单示例网站的HTTP管道化

![](https://res.weread.qq.com/wrepub/epub_32517945_40)

管道化技术应该会对HTTP带来巨大的性能改善，但由于多种原因，它很难实现，易于出错，并且没有获得Web浏览器和Web服务器的良好支持。因此，它很少被
使用。没有一个主流的Web浏览器支持管道化技术。

即使管道化技术得到了更好的支持，它仍然需要**按照请求的顺序返回响应**。如果图像2可用，但必须从另一台服务器获取图像1，则图像2的响应会等待，即
使应该可以立即发送图像2。此问题被称为**队头（HOL）阻塞问题**，在其他网络协议及HTTP中很常见。

### 2.1.3 网络性能瀑布流图

图2.4　示例网站的请求瀑布图

![](https://res.weread.qq.com/wrepub/epub_32517945_41)

图2.5　示例网站使用管道化技术的瀑布图

![](https://res.weread.qq.com/wrepub/epub_32517945_42)

在这两个示例中，第一条垂直线表示可以渲染初始页面的时间（称为开始绘制时间或开始渲染时间），第二条垂直线表示页面何时加载完成。浏览器通常会在下
载图像之前尝试绘制页面，并在稍后填充图像，因此图像下载通常在这两个时间之间。

图2.6　webpagetest.org上的瀑布图

![](https://res.weread.qq.com/wrepub/epub_32517945_43)

它将每个请求分成几个部分

- DNS查询
- 网络连接时间
- HTTPS（或SSL）协商时间
- 请求的资源分类（并且还将资源负载分成两部分，用于请求的颜色较浅，用于响应的颜色较深）
- 加载页面各个阶段的各种垂直线
- 其他图表，显示CPU使用率、网络带宽，以及浏览器工作在哪个主线程中

## 2.2 解决HTTP/1.1性能问题的方案

随着时间的推移，已经有各种突破HTTP/1.1的性能限制的技术，这些技术分为以下两类：

- 使用多个HTTP连接。
- 合并HTTP请求。

其他的和HTTP关联不大的性能优化技术，包括优化用户请求资源的方式（比如先请求关键CSS），减小下载资源的大小（压缩和使用响应式图片），减少浏览器
的渲染任务（更高效的CSS和JavaScript）。这些技术的细节超出了本书的讨论范围，但我们会在第6章涉及一些。Manning出版社所出版的
[Web Performance in Action](https://www.manning.com/books/web-performance-in-action)（Jeremy Wagner著）一书，是学习这些技术
的绝佳资料。

> [<<Web性能实战>>](https://weread.qq.com/web/bookDetail/c3b322d071f284a6c3bb35d) 内容可能有点旧.

### 2.2.1 使用多个HTTP连接

与管道化技术不同，该技术不会导致HOL阻塞，因为每个HTTP连接都独立于其他HTTP连接。因此，大多数浏览器可以为每个域名打开6个连接。

为了进一步突破6个连接的限制，许多网站从子域提供静态资源, 如图像、CSS和JavaScript，Web浏览器从而可以为每个新域名打开另外6个连接。这种技术称
为**域名分片**

- 除了提高并发数，域名发散还有其他优势，比如减小HTTP请求首部（如cookies）

图2.7　stackoverflow.com使用多个域名加载资源

![](https://res.weread.qq.com/wrepub/epub_32517945_44)

使用多个http连接的缺点

- 打开TCP连接需要时间
- 维护连接需要更多的内存和CPU资源。

图2.8　TCP三次握手

![](https://res.weread.qq.com/wrepub/epub_32517945_45)

TCP在开启连接时比较小心，在确认网络不拥堵之前只会发送比较少的数据包。CWND（Congestion Window，拥塞窗口）随着时间的推移逐渐增加，只要连接
没发现丢包，就可以处理更大的流量。

- TCP拥塞窗口的大小受TCP慢启动算法控制。
- 在拥塞窗口中的TCP数据包需要在收到ACK消息之后发送。
- 在CWND比较小时，可能需要多个TCP ACK消息才能发出一个完整的HTTP请求。
- HTTP响应常常比请求大很多，所以它同样也会受到拥塞窗口的影响。

最后，就算没有TCP建立连接的开销和慢启动的问题，使用多个独立的连接也可能导致带宽问题。例如，如果所有带宽都用掉了，就会导致TCP超时，和其他的
连接上的重传。在这些独立的连接之间，没有优先级的概念，这就无法更高效地利用带宽。

> 优先级如何使带宽高效利用?

创建TCP连接之后，安全的网站要求建立HTTPS连接。这个过程可以节约开销，比如，重用TCP连接的参数，不从零开始。但这个过程依然需要更多的网络往返，这意
味着更多的时间。

> - 使用多个连接会导致额外的tcp/https握手过程, 反而导致延迟问题.
> - 过多的连接数, 收益会比较低

### 2.2.2 发送更少的请求

- 减少不必要的请求, 比如在浏览器中缓存静态资源(相当于不发请求)
- 以更少的HTTP请求获取同样的资源(打包合并静态资源)

对于图片来说，这种打包技术叫作精灵图。

图2.9　TinyPNG的精灵图

![](https://res.weread.qq.com/wrepub/epub_32517945_46)

如果是CSS和JavaScript文件，很多网站就将多个文件合并为一个文件，这样需要的请求数就少了，但是总的代码量并不少。在合并文件的时候，通常还会去掉代码
中不必要的空格、注释和其他不必要的元素，以减小CSS和JavaScript的文件尺寸。这些方法都会提升效率，但是会增加配置的难度。

其他的技术还包括内联资源到其他文件。比如，Critical CSS经常直接被内联在HTML的`<style>`标签中。图片可以包含在CSS中，通过行内SVG，或者转换为
Base64编码，也能减少HTTP请求数。

另外一个问题是，合并会导致文件的浪费。

- 一些网页可能只用到一张精灵图中的一两个图标，但却要下载整张精灵图。
- 当有新的精灵图时，还要重写CSS文件，以防止新的精灵图中图标的位置发生变化。
- 同样，如果合并了太多文件，JavaScript也可能会变得臃肿。有时候我们只需要其中的很少一部分，却要下载一个大得多的文件。
- 无论是从网络的方面（特别在开始的时候，TCP启动慢）还是从浏览器执行的方面（浏览器需要处理它不需要的代码）来说，这种技术都不够高效。

最后一个问题是缓存。

- 如果把精灵图缓存了很长一段时间（这样用户就不需要频繁下载它），当需要添加一个图标的时候，必须让浏览器再次下载整个精灵图，但访客并不需要。
- 可以使用很多技术来解决这个问题，比如添加版本号或者使用查询参数，但是这些技术也会浪费资源。使用CSS和JavaScript也一样，改变一行代码就需要重新下
  载整个合并文件。

### 2.2.3 HTTP/1性能优化总结

归根到底，优化HTTP/1性能的方法是一些解决HTTP/1基础缺陷的小技巧。应该有更好的办法在协议层面解决这个问题，从而节省时间，这正是HTTP/2要做的。

## 2.3 HTTP/1.1的其他问题

- 基于文本的协议处理起来复杂易出错, 还会导致安全问题.
- 文本协议编码效率不高, 体积大
- 首部内容有重复
  - 就算只有主页需要cookie，每个发向服务器的HTTP请求中都会包含cookie。
- 纯文本协议的安全和隐私问题（HTTPS加密很好地解决了这个问题）
- 缺少状态的问题（cookie在一定程度上解决了这个问题）。

## 2.4 实际案例

