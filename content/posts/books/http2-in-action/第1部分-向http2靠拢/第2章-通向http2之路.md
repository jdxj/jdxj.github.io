---
title: "第2章 通向http2之路"
date: 2023-03-18T11:23:11+08:00
---

## 2.1 HTTP/1.1和当前的万维网

图2.1　网站加载内容平均大小（2014年—2018年）

![](https://res.weread.qq.com/wrepub/epub_32517945_37)

表2.1　美国访问量排名前10网站

![](https://res.weread.qq.com/wrepub/epub_32517945_38)

### 2.1.1 HTTP/1.1根本的性能问题

图2.2　在一个简单的网站示例中，HTTP请求及响应的流程

![](https://res.weread.qq.com/wrepub/epub_32517945_39)

- 处理时间在整个请求流程中占比很小, 大部分时间都在等待, 效率低
- 现代互联网最大的问题之一是延迟而不是带宽。

### 2.1.2 HTTP/1.1管道化

图2.3　简单示例网站的HTTP管道化

![](https://res.weread.qq.com/wrepub/epub_32517945_40)

管道化技术应该会对HTTP带来巨大的性能改善，但由于多种原因，它很难实现，易于出错，并且没有获得Web浏览器和Web服务器的良好支持。因此，它很少被
使用。没有一个主流的Web浏览器支持管道化技术。

即使管道化技术得到了更好的支持，它仍然需要**按照请求的顺序返回响应**。如果图像2可用，但必须从另一台服务器获取图像1，则图像2的响应会等待，即
使应该可以立即发送图像2。此问题被称为**队头（HOL）阻塞问题**，在其他网络协议及HTTP中很常见。

### 2.1.3 网络性能瀑布流图

图2.4　示例网站的请求瀑布图

![](https://res.weread.qq.com/wrepub/epub_32517945_41)

图2.5　示例网站使用管道化技术的瀑布图

![](https://res.weread.qq.com/wrepub/epub_32517945_42)

在这两个示例中，第一条垂直线表示可以渲染初始页面的时间（称为开始绘制时间或开始渲染时间），第二条垂直线表示页面何时加载完成。浏览器通常会在下
载图像之前尝试绘制页面，并在稍后填充图像，因此图像下载通常在这两个时间之间。

图2.6　webpagetest.org上的瀑布图

![](https://res.weread.qq.com/wrepub/epub_32517945_43)

它将每个请求分成几个部分

- DNS查询
- 网络连接时间
- HTTPS（或SSL）协商时间
- 请求的资源分类（并且还将资源负载分成两部分，用于请求的颜色较浅，用于响应的颜色较深）
- 加载页面各个阶段的各种垂直线
- 其他图表，显示CPU使用率、网络带宽，以及浏览器工作在哪个主线程中

## 2.2 解决HTTP/1.1性能问题的方案

随着时间的推移，已经有各种突破HTTP/1.1的性能限制的技术，这些技术分为以下两类：

- 使用多个HTTP连接。
- 合并HTTP请求。

其他的和HTTP关联不大的性能优化技术，包括优化用户请求资源的方式（比如先请求关键CSS），减小下载资源的大小（压缩和使用响应式图片），减少浏览器
的渲染任务（更高效的CSS和JavaScript）。这些技术的细节超出了本书的讨论范围，但我们会在第6章涉及一些。Manning出版社所出版的
[Web Performance in Action](https://www.manning.com/books/web-performance-in-action)（Jeremy Wagner著）一书，是学习这些技术
的绝佳资料。

> [<<Web性能实战>>](https://weread.qq.com/web/bookDetail/c3b322d071f284a6c3bb35d) 内容可能有点旧.

### 2.2.1 使用多个HTTP连接

与管道化技术不同，该技术不会导致HOL阻塞，因为每个HTTP连接都独立于其他HTTP连接。因此，大多数浏览器可以为每个域名打开6个连接。

为了进一步突破6个连接的限制，许多网站从子域提供静态资源, 如图像、CSS和JavaScript，Web浏览器从而可以为每个新域名打开另外6个连接。这种技术称
为**域名分片**

- 除了提高并发数，域名发散还有其他优势，比如减小HTTP请求首部（如cookies）

图2.7　stackoverflow.com使用多个域名加载资源

![](https://res.weread.qq.com/wrepub/epub_32517945_44)

使用多个http连接的缺点

- 打开TCP连接需要时间
- 维护连接需要更多的内存和CPU资源。

图2.8　TCP三次握手

![](https://res.weread.qq.com/wrepub/epub_32517945_45)

TCP在开启连接时比较小心，在确认网络不拥堵之前只会发送比较少的数据包。CWND（Congestion Window，拥塞窗口）随着时间的推移逐渐增加，只要连接
没发现丢包，就可以处理更大的流量。

- TCP拥塞窗口的大小受TCP慢启动算法控制。
- 在拥塞窗口中的TCP数据包需要在收到ACK消息之后发送。
- 在CWND比较小时，可能需要多个TCP ACK消息才能发出一个完整的HTTP请求。
- HTTP响应常常比请求大很多，所以它同样也会受到拥塞窗口的影响。

最后，就算没有TCP建立连接的开销和慢启动的问题，使用多个独立的连接也可能导致带宽问题。例如，如果所有带宽都用掉了，就会导致TCP超时，和其他的
连接上的重传。在这些独立的连接之间，没有优先级的概念，这就无法更高效地利用带宽。

> 优先级如何使带宽高效利用?

创建TCP连接之后，安全的网站要求建立HTTPS连接。这个过程可以节约开销，比如，重用TCP连接的参数，不从零开始。但这个过程依然需要更多的网络往返，这意
味着更多的时间。

> - 使用多个连接会导致额外的tcp/https握手过程, 反而导致延迟问题.
> - 过多的连接数, 收益会比较低

### 2.2.2 发送更少的请求

- 减少不必要的请求, 比如在浏览器中缓存静态资源(相当于不发请求)
- 以更少的HTTP请求获取同样的资源(打包合并静态资源)

对于图片来说，这种打包技术叫作精灵图。

图2.9　TinyPNG的精灵图

![](https://res.weread.qq.com/wrepub/epub_32517945_46)

如果是CSS和JavaScript文件，很多网站就将多个文件合并为一个文件，这样需要的请求数就少了，但是总的代码量并不少。在合并文件的时候，通常还会去掉代码
中不必要的空格、注释和其他不必要的元素，以减小CSS和JavaScript的文件尺寸。这些方法都会提升效率，但是会增加配置的难度。

其他的技术还包括内联资源到其他文件。比如，Critical CSS经常直接被内联在HTML的`<style>`标签中。图片可以包含在CSS中，通过行内SVG，或者转换为
Base64编码，也能减少HTTP请求数。

另外一个问题是，合并会导致文件的浪费。

- 一些网页可能只用到一张精灵图中的一两个图标，但却要下载整张精灵图。
- 当有新的精灵图时，还要重写CSS文件，以防止新的精灵图中图标的位置发生变化。
- 同样，如果合并了太多文件，JavaScript也可能会变得臃肿。有时候我们只需要其中的很少一部分，却要下载一个大得多的文件。
- 无论是从网络的方面（特别在开始的时候，TCP启动慢）还是从浏览器执行的方面（浏览器需要处理它不需要的代码）来说，这种技术都不够高效。

最后一个问题是缓存。

- 如果把精灵图缓存了很长一段时间（这样用户就不需要频繁下载它），当需要添加一个图标的时候，必须让浏览器再次下载整个精灵图，但访客并不需要。
- 可以使用很多技术来解决这个问题，比如添加版本号或者使用查询参数，但是这些技术也会浪费资源。使用CSS和JavaScript也一样，改变一行代码就需要重新下
  载整个合并文件。

### 2.2.3 HTTP/1性能优化总结

归根到底，优化HTTP/1性能的方法是一些解决HTTP/1基础缺陷的小技巧。应该有更好的办法在协议层面解决这个问题，从而节省时间，这正是HTTP/2要做的。

## 2.3 HTTP/1.1的其他问题

- 基于文本的协议处理起来复杂易出错, 还会导致安全问题.
- 文本协议编码效率不高, 体积大
- 首部内容有重复
  - 就算只有主页需要cookie，每个发向服务器的HTTP请求中都会包含cookie。
- 纯文本协议的安全和隐私问题（HTTPS加密很好地解决了这个问题）
- 缺少状态的问题（cookie在一定程度上解决了这个问题）。

## 2.4 实际案例

用于测试web性能的[WebPageTest](https://www.webpagetest.org/)

### 2.4.1 示例网站1: amazon.com

图2.10　www.amazon.com的部分运行结果

![](https://res.weread.qq.com/wrepub/epub_32517945_47)

首个请求是主页的请求

图2.11　首页的第一个请求

![](https://res.weread.qq.com/wrepub/epub_32517945_48)

HTML引用了几个CSS文件

![](https://res.weread.qq.com/wrepub/epub_32517945_49)

图2.13　图片下载

![](https://res.weread.qq.com/wrepub/epub_32517945_50)

图2.14　加载amazon.com的连接视图

![](https://res.weread.qq.com/wrepub/epub_32517945_51)

### 2.4.2 示例网站2：imgur.com

图2.15　imgur.com的瀑布图

![](https://res.weread.qq.com/wrepub/epub_32517945_52)

图2.16　Chrome开发者工具中imgur.com的瀑布图

![](https://res.weread.qq.com/wrepub/epub_32517945_53)

### 2.4.3 这个问题究竟有多严重

你必须认识到，和其他性能问题想比，HTTP协议的问题有多严重。导致网站缓慢的原因很多，从网络连接的质量到网站的大小，再到某些网站可能使用荒唐的
JavaScript文件数，再到越来越多的性能低下的广告、数据追踪服务，等等。尽管更高效和更快地下载资源可以解决一部分问题，但是很多网站还是会慢。很多网站
清楚地知道HTTP协议对网站性能的影响，所以他们实现了一些优化HTTP/1.1性能的方法。但是因为这些方法复杂且难以理解，所以很多其他的网站没有实现。

另外一个问题是，这些解决方案也有一些限制。这些方案本身也会引入低效率的因素，随着网站内容和复杂度的增加，最终这些变通的解决方案也会失效。尽管浏览器
在每个域名上打开6个连接，并且可以增大这个数，但这么做的收益较低，这也是为什么浏览器限制并发的连接数为6个，尽管站长们可以通过域名分片的方法来突破这
个限制。

## 2.5 从HTTP/1.1到HTTP/2

工作组曾经展开过新版本的工作（HTTP-NG)，该工作本应对HTTP的工作方式做完全的重新设计，但是1999年该工作被中止了。人们普遍感觉这些变化太复杂，无法
推广。

### 2.5.1 SPDY

HTTP-NG尝试解决HTTP/1的多种问题，而SPDY的主要目标是解决HTTP/1.1的性能问题。它引入了一些关键的概念来解决HTTP/1.1的问题：

- 流多路利用 —— 请求和响应使用单个TCP连接传输数据，它们被分成不同的数据包，以流的方式分组。
- 请求优先级 —— 在同时发送所有请求时，为了避免引入新的性能问题，引入了请求优先级的概念。
- HTTP首部压缩 —— HTTP体早就可以压缩了，现在首部也可以压缩了。

SPDY在HTTP层实现了TCP的相关概念，所以它可以同时传输不同的HTTP消息。

服务器推送这种高级功能，允许服务器返回额外的资源。如果你请求主页面，服务器可以在主页面的请求中推送所需要的CSS文件内容。这种方式可以节省浏览器再次
发送CSS请求的时间，也能避免将critical CSS变为行内样式带来的复杂度。

图2.17　自HTTP/2发布以来，SPDY的支持率下降

![](https://res.weread.qq.com/wrepub/epub_32517945_54)

### 2.5.2 HTTP/2

我想要强调的是，HTTP/2已经向你走来，请尽情使用它。它已经在实际应用中得到验证，可以显著提高性能，而且它解决了本章中描述的HTTP/1.1的问题。

## 2.6 HTTP/2对Web性能的影响

### 2.6.1 展示HTTP/2能力的绝佳示例

[作者的网站](https://www.tunetheweb.com/performance-test-360/)

图2.18　HTTP、HTTPS、HTTP/2性能测试

![](https://res.weread.qq.com/wrepub/epub_32517945_55)

图2.19　HTTPS测试的瀑布图。忽略第18行，其是个302响应。

![](https://res.weread.qq.com/wrepub/epub_32517945_56)

图2.20　HTTP/2测试的瀑布图

![](https://res.weread.qq.com/wrepub/epub_32517945_57)

图2.21　HTTP/2下的延迟和瀑布图

![](https://res.weread.qq.com/wrepub/epub_32517945_58)

### 2.6.2 对HTTP/2提升性能的期望

如果网站还有其他性能问题，那么切换到HTTP/2后可能看不到任何性能提升，这也意味着HTTP/1.1的低效率对这些网站来说问题不大。

对于一些网站，还有两个原因会导致使用HTTP/2没什么改善。

- 第一个原因是这些网站已经优化得足够好了——使用2.2节中提到的变通办法，由HTTP/1带来的缓慢问题比较少。
- 其他的性能问题远超HTTP/1带来的影响。

让HTTP/2变慢的其他情况还是网络丢包

表2.2　HTTP/2可能给Amazon带来的提升

![](https://res.weread.qq.com/wrepub/epub_32517945_59)

- 加载时间指页面发起onload事件的时间 —— 通常指所有的CSS和阻塞式JavaScript加载完成的时间。
- 首字节时间指从网站收到第一个字节的时间。通常，此响应是第一个真正的响应，不是重定向。
- 开始渲染时间指页面开始绘制的时间。此指标是一项关键性能指标，因为如果用户没有看到正在访问的页面有更新，他们可能会离开。
- 视觉完整时间指页面停止变化的时间，通常在初始加载时间之后很久，异步的JavaScript可能还在更新页面。
- speed index为由WebPagetest计算的页面每部分加载的平均时间，以ms为单位。

图2.22　通过HTTP/1加载Amazon主页的一个副本

![](https://res.weread.qq.com/wrepub/epub_32517945_60)

图2.23　通过HTTP/2加载Amazon主页的一个副本

![](https://res.weread.qq.com/wrepub/epub_32517945_61)

### 2.6.3 HTTP/1.1的一些性能变通方法可能是反模式

例如，如果网站使用域名分片并强制使用多个连接，则无法享受使用单个TCP连接加载网站带来的性能提升。HTTP/2使得在默认情况下创建一个高性能网站变得更加
简单。

然而，事实并非如此简单，，在HTTP/2的应用更加广泛之前，完全放弃这些技术可能为时尚早。在客户端，尽管有强大的浏览器支持，一些用户仍会使用HTTP/1.1。
他们可能正在使用较旧的浏览器，或通过尚不支持HTTP/2的代理（包括防病毒扫描程序和公司代理）进行连接。

## 总结

- HTTP/1.1存在一些根本的性能问题，特别是在获取多个资源时。
- 对于这些性能问题有多种变通的解决方法（使用多个连接、域名分片，以及使用精灵图等），但它们有其自身的缺点。
- 可以通过WebPageTest等工具生成瀑布图，从中很容易看到性能问题。
- SPDY旨在解决这些性能问题。
- HTTP/2是SPDY的标准化版本。
- 并非所有性能问题都可以通过HTTP/2解决。
