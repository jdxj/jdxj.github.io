---
title: "第3章 升级到HTTP/2"
date: 2023-03-20T21:58:08+08:00
---

## 3.1 HTTP/2的支持

你能否在网站上使用新的网络技术，主要取决于三点：

- 浏览器是否支持这项技术？
- 你的基础设施是否支持？
- 如果这项技术未获得支持，是否有健壮的回退机制？

### 3.1.1 浏览器对HTTP/2的支持

图3.1　caniuse.com中的HTTP/2数据

![](https://res.weread.qq.com/wrepub/epub_32517945_62)

图3.2　caniuse.com中的HTTP/2数据，Usage Relative视图

![](https://res.weread.qq.com/wrepub/epub_32517945_63)

浏览器对HTTP/2和HTTPS的支持

在前面的图中，每个支持HTTP/2的浏览器都有一个小2作为备注，底部有“仅支持基于TLS的HTTP2（https）”的说明，因此不使用HTTPS的网站无法从HTTP/2中受
益。SPDY也有类似的限制，当HTTP/2被标准化时，人们也对此限制进行了大篇幅的讨论，许多参与方都要求强制将HTTPS作为规范的一部分。后来，这个要求被排除
在HTTP/2的正式规范之外，但是**所有浏览器厂商都表示，他们将仅支持基于HTTPS的HTTP/2，这使其成为事实上的标准**。要求支持HTTPS无疑会使仅支持HTTP
网站的站长不开心，但这种要求有两个很好的理由。

- 第一个理由纯粹从实用方面考虑。仅通过HTTPS使用HTTP/2意味着不太可能出现兼容性问题。网上许多基于HTTP的基础设施，在升级之前不知道如何处理HTTP/2
  消息。在HTTPS中包装消息，可以隐藏HTTP消息本身，从而避免兼容性问题。
- 第二个理由比较主观。许多浏览器厂商（和其他人，包括我）坚信，要远离未加密的HTTP，所有网站都应该转向HTTPS。因此，较新的功能通常仅支持HTTPS，以
  鼓励人们切换为HTTPS。

即使你的网站支持了HTTPS，仍可能遇到问题。

- 一些浏览器（如Chrome、Firefox和Opera）上的备注4意味着“只有服务器支持ALPN，其才支持HTTP2。
- 许多浏览器在使用HTTP/2之前需要更新为更安全的密码套件。

中间代理

为了能够使用HTTP/2，浏览器和服务器都必须支持HTTP/2。但是，如果用户使用代理，把一个HTTP连接变成两个，且这个代理不支持HTTP/2，那HTTP/2还是不能
启用。

查看计算机是否使用代理的最简单方法，是查看HTTPS证书，看看它是由谁颁发的，由真正的证书颁发机构颁发（有很多证书颁发机构，所以可能弄不清楚）还是由本
地软件颁发。

图3.3　查看直接连接Google和通过反病毒产品连接Google时的HTTPS证书

![](https://res.weread.qq.com/wrepub/epub_32517945_64)

浏览器对HTTP/2支持情况的总结

- 有几个情况可能导致无法使用HTTP/2，如服务端HTTPS设置不匹配，在使用拦截代理等。
- 对HTTPS的要求，尤其对ALPN的要求，使得启用HTTP/2变得更复杂了，会引起疑惑。这里的复杂性主要体现在，要求服务器正确设置
- 论。网络正朝着HTTPS大步迈进，未加密的HTTP网站受到的惩罚将继续增加，会有更明显的警告，新功能更少。

evergreen浏览器

一些浏览器（如Chrome和Firefox）会在后台静默更新，不提示用户，我们称之为evergreen浏览器。这些浏览器的用户可能运行的是最新版本的浏览器，它们支持
HTTP/2。

### 3.1.2 服务器对HTTP/2的支持

HTTPS库及其对HTTP/2的支持

Chrome和Opera仅支持基于ALPN的HTTP/2，而不支持NPN（Next Protocol Negotiation，下一代协议协商）。与之前的NPN一样，ALPN允许Web服务器在
HTTPS协商的过程中，声明服务器支持哪些应用程序协议；

- 问题是ALPN仅包含在最新版本的OpenSSL（1.0.2及更高版本）中，在很多标准版本中并没有包含。

表3.1　不同的Linux系统对ALPN的支持

![](https://res.weread.qq.com/wrepub/epub_32517945_65)

服务端支持总结

### 3.1.3 兼容不支持HTTP/2的情况

当客户端不支持HTTP/2时，网站仍然能正常工作，因为它们可以降级到HTTP/1.1。HTTP/1.1距离被废弃（如果会的话）还很遥远。从理论上讲，如果可能，应该启
用HTTP/2，因为并没有客户端不支持的问题。

## 3.2 网站开启HTTP/2的方法

### 3.2.1 在Web服务器上开启HTTP/2

图3.4　Web服务器上的HTTP/2

![](https://res.weread.qq.com/wrepub/epub_32517945_66)

表3.2　流行的Web服务器开始支持HTTP/2的版本

![](https://res.weread.qq.com/wrepub/epub_32517945_67)

### 3.2.2 反向代理实现HTTP/2

图3.5　通过反向代理实现HTTP/2

![](https://res.weread.qq.com/wrepub/epub_32517945_68)

反向代理很常见，主要用于以下两种场景：

- 作为负载均衡器
- 用以卸载一些功能，如HTTPS或者HTTP/2

图3.6　反向代理负载均衡

![](https://res.weread.qq.com/wrepub/epub_32517945_69)

**是否需要在整个链路中支持HTTP/2**

HTTP/2的主要优点是可以提升高延迟、低带宽连接的速度，连接到边缘服务器（在这种情况下为反向代理）的用户通常处在这样的网络环境下。从反向代理到其他Web
基础架构的流量一般处于低延迟、高带宽、短距离的网络环境中（即使不是同一台机器，也通常是相同的数据中心），因此此场景下通常不需要考虑HTTP/1.1的性能
问题。

如果反向代理到实际服务器的连接使用HTTP/2，则采用HTTP/2单个连接的方式收益也不高。因为反向代理到服务器的连接数不受限于浏览器设置的6个连接。甚至有
些人担心使用单个连接可能会导致性能问题，具体取决于在反向代理和目标服务器上的实现方式。**Nginx已经声明，它不会为代理连接实现HTTP/2**，所以也有这
方面原因。

图3.7　在应用服务器/数据库服务器之前使用Web服务器

![](https://res.weread.qq.com/wrepub/epub_32517945_70)

图3.8　添加临时的反向代理，来测试HTTP/2

![](https://res.weread.qq.com/wrepub/epub_32517945_71)

### 3.2.3 通过CDN实现HTTP/2

大多数CDN已经支持HTTP/2了，所以你可以通过使用CDN的方式来启用HTTP/2，而源站只需要支持HTTP/1.1就行了。这个方法和使用反向代理类似，但是CDN有很
多反向代理服务器，它们可以帮你管理这个基础架构。

图3.9　通过CDN启用HTTP/2

![](https://res.weread.qq.com/wrepub/epub_32517945_72)

### 3.2.4 小结

## 3.3 常见问题

表3.3　常见TLS库对ALPN的支持

![](https://res.weread.qq.com/wrepub/epub_32517945_74)

## 总结
